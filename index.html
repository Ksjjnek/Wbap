<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plinko Pro Max</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --blue: #0a84ff; --green: #32d74b; --red: #ff453a; --gray: #2c2c2e; }
        body {
            margin: 0; background: #1c1c1e; color: white;
            font-family: -apple-system, sans-serif; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        /* –®–∞–ø–∫–∞ */
        .header { width: 100%; padding: 10px 15px; display: flex; align-items: center; box-sizing: border-box; }
        .profile { display: flex; align-items: center; background: var(--gray); padding: 4px 12px 4px 4px; border-radius: 25px; cursor: pointer; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #444; }
        .bal-val { margin-left: 8px; font-weight: bold; font-size: 14px; }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ */
        .toggle-box {
            position: relative; width: 90%; background: var(--gray); border-radius: 12px;
            display: flex; padding: 3px; margin: 10px 0;
        }
        .toggle-btn { flex: 1; text-align: center; padding: 8px; z-index: 2; font-size: 13px; font-weight: 600; cursor: pointer; }
        .slider {
            position: absolute; top: 3px; left: 3px; width: calc(50% - 3px); height: calc(100% - 6px);
            background: var(--blue); border-radius: 9px; transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 1;
        }
        .active-right .slider { transform: translateX(100%); }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        #game { width: 100%; height: 320px; position: relative; }
        canvas { position: absolute; top: 0; left: 0; }

        .mults { display: flex; justify-content: center; gap: 3px; width: 100%; padding: 0 5px; box-sizing: border-box; }
        .m-tile {
            flex: 1; padding: 6px 0; border-radius: 4px; text-align: center; font-size: 9px;
            font-weight: bold; transition: 0.5s; opacity: 0; transform: translateY(10px);
        }
        .m-tile.show { opacity: 1; transform: translateY(0); }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .panel { width: 90%; margin-top: 15px; }
        .balls-grid { display: flex; justify-content: space-between; gap: 4px; margin-bottom: 10px; }
        .b-btn { flex: 1; background: var(--gray); border: none; color: white; padding: 8px 0; border-radius: 8px; font-size: 12px; font-weight: bold; }
        .b-btn.active { background: var(--green); }

        .play-btn { width: 100%; background: var(--green); border: none; color: white; padding: 15px; border-radius: 15px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(50, 215, 75, 0.3); }
        .play-btn:active { transform: scale(0.96); }
        .cost-info { text-align: center; margin-top: 8px; color: #ff9f0a; font-size: 14px; font-weight: 600; }

        /* –¢–µ–∫—Å—Ç –≤—ã–∏–≥—Ä—ã—à–∞ */
        .float {
            position: fixed; pointer-events: none; font-weight: 900; z-index: 100;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            20% { transform: translateY(-10px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-70px) scale(1); opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="profile">
            <img id="avatar" src="" class="avatar">
            <div class="bal-val" id="top-bal">1000 ü™ô</div>
        </div>
    </div>

    <div class="toggle-box" id="mode-t">
        <div class="slider"></div>
        <div class="toggle-btn" onclick="setMode('demo')">–î–µ–º–æ</div>
        <div class="toggle-btn" onclick="setMode('real')">–ë–∞–ª–∞–Ω—Å</div>
    </div>

    <div id="game"></div>
    <div class="mults" id="mults-row"></div>

    <div class="panel">
        <div class="balls-grid">
            <button class="b-btn active" onclick="setB(1, this)">1</button>
            <button class="b-btn" onclick="setB(2, this)">2</button>
            <button class="b-btn" onclick="setB(5, this)">5</button>
            <button class="b-btn" onclick="setB(10, this)">10</button>
            <button class="b-btn" onclick="setB(25, this)">25</button>
            <button class="b-btn" onclick="setB(50, this)">50</button>
        </div>

        <div class="toggle-box" id="bet-t">
            <div class="slider"></div>
            <div class="toggle-btn" onclick="setBet(10)">10</div>
            <div class="toggle-btn" onclick="setBet(100)">100</div>
        </div>

        <button class="play-btn" onclick="play()">–ò–ì–†–ê–¢–¨</button>
        <div class="cost-info" id="warn">–° –±–∞–ª–∞–Ω—Å–∞ —Å–ø–∏—à–µ—Ç—Å—è: 10 ü™ô</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let dBal = 1000, rBal = 0, mode = 'demo', balls = 1, bet = 10;
        let particles = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —é–∑–µ—Ä–∞
        const u = tg.initDataUnsafe?.user;
        document.getElementById('avatar').src = u?.photo_url || `https://ui-avatars.com/api/?name=${u?.first_name || 'U'}&background=32d74b&color=fff`;

        function updateUI() {
            if(dBal < 100) dBal = 100;
            document.getElementById('top-bal').innerText = mode === 'demo' ? `${Math.floor(dBal)} ü™ô` : `${rBal.toFixed(2)} USDT`;
            document.getElementById('warn').innerText = `–° –±–∞–ª–∞–Ω—Å–∞ —Å–ø–∏—à–µ—Ç—Å—è: ${balls * bet} ${mode === 'demo' ? 'ü™ô' : 'USDT'}`;
        }

        function setMode(m) { mode = m; document.getElementById('mode-t').classList.toggle('active-right', m==='real'); updateUI(); }
        function setBet(b) { bet = b; document.getElementById('bet-t').classList.toggle('active-right', b===100); updateUI(); }
        function setB(n, el) { balls = n; document.querySelectorAll('.b-btn').forEach(x => x.classList.remove('active')); el.classList.add('active'); updateUI(); }

        // --- –°–∏—Å—Ç–µ–º–∞ —á–∞—Å—Ç–∏—Ü ---
        function createParticles(x, y, color) {
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8 - 3,
                    radius: Math.random() * 3 + 1,
                    color: color,
                    life: 1.0
                });
            }
        }

        // --- –≠—Ñ—Ñ–µ–∫—Ç—ã —Ç–µ–∫—Å—Ç–∞ ---
        function spawnText(x, y, v, m) {
            const el = document.createElement('div');
            el.className = 'float';
            if(m >= 1.5) { el.innerText = `+${v} üî•`; el.style.color = '#32d74b'; createParticles(x, y, '#32d74b'); }
            else if(m === 1) { el.innerText = `–í–û–ó–í–†–ê–¢`; el.style.color = '#fff'; createParticles(x, y, '#fff'); }
            else { el.innerText = `-${(bet-v).toFixed(0)} üíÄ`; el.style.color = '#ff453a'; createParticles(x, y, '#ff453a'); }
            el.style.left = x + 'px'; el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // --- –§–∏–∑–∏–∫–∞ ---
        const { Engine, Render, Runner, Bodies, Composite, Events, Vector } = Matter;
        const eng = Engine.create();
        const ren = Render.create({ 
            element: document.getElementById('game'), 
            engine: eng, 
            options: { width: 400, height: 320, wireframes: false, background: 'transparent' } 
        });

        const conf = [
            {l:'0x', v:0, c:'#444'}, {l:'0.5x', v:0.5, c:'#ff9f0a'}, {l:'1.5x', v:1.5, c:'#ff9f0a'},
            {l:'10x', v:10, c:'#32d74b'}, {l:'3x', v:3, c:'#ff9f0a'}, {l:'1x', v:1, c:'#ffd60a'}, {l:'0x', v:0, c:'#444'}
        ];

        const CAT_BALL = 0x0002, CAT_STATIC = 0x0001;

        conf.forEach((m, i) => {
            const d = document.createElement('div');
            d.className = 'm-tile'; d.innerText = m.l; d.style.background = m.c;
            document.getElementById('mults-row').appendChild(d);
            setTimeout(() => d.classList.add('show'), 300 + i*50);

            const s = Bodies.rectangle(65 + i*45, 310, 35, 20, { isStatic: true, isSensor: true, label: 's_'+i, render: {visible: false} });
            Composite.add(eng.world, s);
        });

        // –ö–æ–ª—ã—à–∫–∏
        for(let i=2; i<9; i++) {
            for(let j=0; j<=i; j++) {
                const peg = Bodies.circle(200 + (j*34) - (i*17), 40 + (i*30), 3, { 
                    isStatic: true, 
                    label: 'peg',
                    collisionFilter: { category: CAT_STATIC },
                    render: { fillStyle: '#fff' } 
                });
                Composite.add(eng.world, peg);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
        Events.on(eng, 'collisionStart', e => {
            e.pairs.forEach(p => {
                const b = p.bodyA.label === 'b' ? p.bodyA : (p.bodyB.label === 'b' ? p.bodyB : null);
                const s = p.bodyA.label.startsWith('s_') ? p.bodyA : (p.bodyB.label.startsWith('s_') ? p.bodyB : null);
                const peg = p.bodyA.label === 'peg' ? p.bodyA : (p.bodyB.label === 'peg' ? p.bodyB : null);

                // 1. –õ–û–ì–ò–ö–ê –ü–ï–†–í–û–ì–û –û–¢–°–ö–û–ö–ê (80/20)
                if(b && peg && !b.firstHit) {
                    b.firstHit = true;
                    if(Math.random() < 0.20) { // 20% —à–∞–Ω—Å "—Å–ª–∞–±–æ–≥–æ" –æ—Ç—Å–∫–æ–∫–∞
                        // –ó–∞–º–µ–¥–ª—è–µ–º —à–∞—Ä–∏–∫ –∏ —Ç–æ–ª–∫–∞–µ–º –µ–≥–æ –∫ —Ü–µ–Ω—Ç—Ä—É (x=200)
                        const directionToCenter = 200 - b.position.x;
                        Matter.Body.setVelocity(b, { 
                            x: directionToCenter * 0.05, 
                            y: b.velocity.y * 0.5 
                        });
                        b.restitution = 0.3; // –î–µ–ª–∞–µ–º –º–µ–Ω–µ–µ –ø—Ä—ã–≥—É—á–∏–º
                    }
                }

                // 2. –ü–û–ü–ê–î–ê–ù–ò–ï –í –õ–£–ù–ö–£
                if(b && s) {
                    const m = conf[s.label.split('_')[1]];
                    const win = b.bet * m.v;
                    if(b.mode === 'demo') dBal += win; else rBal += win;
                    spawnText(s.position.x, 280, win, m.v);
                    updateUI();
                    Composite.remove(eng.world, b);
                }
            });
        });

        // –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —á–∞—Å—Ç–∏—Ü –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
        Events.on(ren, 'afterRender', () => {
            const ctx = ren.context;
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2; // –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è —á–∞—Å—Ç–∏—Ü
                p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
                
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = p.color + Math.floor(p.life * 255).toString(16).padStart(2, '0');
                ctx.fill();
            });
        });

        Render.run(ren);
        Runner.run(Runner.create(), eng);

        function play() {
            const c = balls * bet;
            if(mode === 'demo' && dBal < c) return tg.showAlert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!");
            if(mode === 'real' && rBal < c) return tg.showAlert("–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å!");

            if(mode === 'demo') dBal -= c; else rBal -= c;
            updateUI();

            for(let i=0; i<balls; i++) {
                setTimeout(() => {
                    const ball = Bodies.circle(200 + (Math.random()*2-1), 10, 6, { 
                        restitution: 0.6, 
                        friction: 0.01, 
                        label: 'b',
                        collisionFilter: { category: CAT_BALL, mask: CAT_STATIC },
                        render: { fillStyle: '#ff3b30' } 
                    });
                    ball.bet = bet; ball.mode = mode; ball.firstHit = false; // –ú–∞—Ä–∫–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —É–¥–∞—Ä–∞
                    Composite.add(eng.world, ball);
                }, i * 120);
            }
        }
        updateUI();
    </script>
</body>
</html>
