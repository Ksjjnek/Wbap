const tg = window.Telegram.WebApp;
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let state = {
            mode: 'demo',
            demoBalance: 1000,
            realBalance: 0,
            isProfileOpen: false,
            isGameOpen: false,
            currentRotationX: -20,
            currentRotationY: 20,
            isRolling: false,
            betAmount: 10,
            betStep: 5,
            winCondition: 'even',
            multiplier: 1.9,
            autoMode: 'none',
            autoActive: false,
            startBalance: 0,
            autoTimeout: null
        };

        // --- –ì–õ–ê–í–ù–´–ô –ë–õ–û–ö –ü–û–õ–£–ß–ï–ù–ò–Ø –î–ê–ù–ù–´–• ---
        function initTelegram() {
            tg.ready();
            tg.expand();

            const user = tg.initDataUnsafe?.user;
            
            const nameElem = document.getElementById('user-full-name');
            const nickElem = document.getElementById('user-nick');
            const photoImg = document.getElementById('user-photo');
            const photoFallback = document.getElementById('user-fallback');
            const blurElem = document.getElementById('profile-blur-bg');

            if (user) {
                // –ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è
                const name = [user.first_name, user.last_name].filter(Boolean).join(' ');
                nameElem.innerText = name || "–£–¥–∞—á–ª–∏–≤—ã–π –ò–≥—Ä–æ–∫";
                
                // –ù–∏–∫–Ω–µ–π–º (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ID –¥–ª—è —Ç–µ—Å—Ç–∞)
                nickElem.innerText = user.username ? `@${user.username}` : `ID: ${user.id}`;
                
                // –ê–≤–∞—Ç–∞—Ä–∫–∞
                if (user.photo_url) {
                    photoImg.src = user.photo_url;
                    photoImg.style.display = 'block';
                    photoFallback.style.display = 'none';
                    blurElem.style.backgroundImage = `url(${user.photo_url})`;
                    blurElem.style.backgroundColor = 'transparent';
                } else {
                    useFallbackAvatar(user.first_name);
                }
            } else {
                // –ï—Å–ª–∏ –º—ã –∑–∞—à–ª–∏ –ù–ï —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
                nameElem.innerText = "–ò–≥—Ä–æ–∫ (Offline)";
                nickElem.innerText = "@not_connected";
                useFallbackAvatar("Guest");
            }
            updateUI();
        }

        function useFallbackAvatar(name) {
            const photoImg = document.getElementById('user-photo');
            const photoFallback = document.getElementById('user-fallback');
            const blurElem = document.getElementById('profile-blur-bg');
            
            photoImg.style.display = 'none';
            photoFallback.style.display = 'flex';
            photoFallback.innerText = name.charAt(0).toUpperCase();
            photoFallback.style.background = 'linear-gradient(135deg, #0088cc, #004466)';
            blurElem.style.backgroundImage = 'none';
            blurElem.style.backgroundColor = '#1c1c1d';
        }

        // --- –ò–ù–¢–ï–†–§–ï–ô–° –ò –ò–ì–†–ê (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ---
        function toggleMode() {
            if(state.isRolling || state.autoActive) return;
            state.mode = state.mode === 'demo' ? 'real' : 'demo';
            document.getElementById('mode-toggle').innerText = state.mode === 'demo' ? '–î–µ–º–æ' : '–ë–∞–ª–∞–Ω—Å';
            tg.HapticFeedback.selectionChanged();
            updateUI();
        }

        function toggleProfile() {
            if(state.isRolling || state.autoActive) return;
            if (state.isGameOpen) return closeGame();
            state.isProfileOpen = !state.isProfileOpen;
            document.body.classList.toggle('profile-open', state.isProfileOpen);
            tg.HapticFeedback.impactOccurred('light');
        }

        function openGame() {
            state.isGameOpen = true;
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            document.body.classList.add('game-open');
            updateUI();
        }

        function closeGame() {
            if(state.autoActive) stopAutoPlay();
            state.isGameOpen = false;
            document.getElementById('menu-screen').classList.add('active');
            document.getElementById('game-screen').classList.remove('active');
            document.body.classList.remove('game-open');
        }

        function getBalance() { return state.mode === 'demo' ? state.demoBalance : state.realBalance; }
        function setBalance(val) { 
            if(state.mode === 'demo') state.demoBalance = val; 
            else state.realBalance = val; 
            updateUI();
        }

        function updateUI() {
            const bal = getBalance();
            const curr = state.mode === 'demo' ? 'üç¨' : '$';
            document.getElementById('header-balance').innerText = `${bal.toFixed(0)} ${curr}`;
            document.getElementById('demo-val').innerText = `${state.demoBalance.toFixed(0)} üç¨`;
            document.getElementById('real-val').innerText = `${state.realBalance.toFixed(2)} $`;
            document.getElementById('bet-input').value = state.betAmount;
            const winAmt = (state.betAmount * state.multiplier).toFixed(1);
            document.getElementById('win-notify').innerText = `–° –≤—ã–∏–≥—Ä—ã—à–∞ –ø–æ–ª—É—á—É: ${winAmt} ${curr}`;
            const rollBtn = document.getElementById('roll-button');
            if(state.autoActive) {
                rollBtn.innerText = "–û–°–¢–ê–ù–û–í–ò–¢–¨ –ê–í–¢–û–ò–ì–†–£";
                rollBtn.classList.add('auto-stop');
            } else {
                rollBtn.innerText = "–ë–†–û–°–ò–¢–¨ üé≤";
                rollBtn.classList.remove('auto-stop');
            }
        }

        function setStep(val) {
            state.betStep = val;
            document.getElementById('step-5').classList.toggle('active', val === 5);
            document.getElementById('step-10').classList.toggle('active', val === 10);
            tg.HapticFeedback.selectionChanged();
        }

        function changeBet(direction) {
            if(state.isRolling || state.autoActive) return;
            let newBet = state.betAmount + (state.betStep * direction);
            if(newBet < 1) newBet = 1;
            if(newBet > getBalance()) newBet = getBalance();
            state.betAmount = newBet;
            tg.HapticFeedback.impactOccurred('light');
            updateUI();
        }

        function manualBetChange() {
            if(state.isRolling || state.autoActive) return;
            let val = parseInt(document.getElementById('bet-input').value) || 1;
            if(val < 1) val = 1;
            if(val > getBalance()) val = getBalance();
            state.betAmount = val;
            updateUI();
        }

        function openConditionModal() { document.getElementById('condition-modal').classList.add('active'); }
        function openMenuModal() { document.getElementById('menu-modal').classList.add('active'); }
        function closeModals(e) { if(e.target.classList.contains('modal-overlay')) e.target.classList.remove('active'); }

        function selectCondition(cond) {
            state.winCondition = cond;
            document.getElementById('cond-even').classList.toggle('selected', cond === 'even');
            document.getElementById('cond-odd').classList.toggle('selected', cond === 'odd');
            document.getElementById('current-condition-text').innerText = cond === 'even' ? '–ß—ë—Ç (1.9x)' : '–ù–µ—á–µ—Ç (1.9x)';
            document.getElementById('condition-modal').classList.remove('active');
            tg.HapticFeedback.selectionChanged();
            updateUI();
        }

        function selectAutoMode(mode) {
            state.autoMode = mode;
            document.getElementById('auto-inf').classList.toggle('selected', mode === 'infinite');
            document.getElementById('auto-limit').classList.toggle('selected', mode === 'limit');
            document.getElementById('check-inf').style.display = mode === 'infinite' ? 'block' : 'none';
            document.getElementById('check-limit').style.display = mode === 'limit' ? 'block' : 'none';
        }

        function handleRollClick() { if(state.autoActive) stopAutoPlay(); else executeRoll(); }

        function startAutoPlay() {
            if(state.autoMode === 'none') return;
            if(getBalance() < state.betAmount) return;
            state.autoActive = true;
            state.startBalance = getBalance();
            document.getElementById('menu-modal').classList.remove('active');
            updateUI();
            executeRoll();
        }

        function stopAutoPlay() { state.autoActive = false; clearTimeout(state.autoTimeout); updateUI(); }

        function executeRoll() {
            if(state.isRolling || getBalance() < state.betAmount) {
                if(state.autoActive) stopAutoPlay();
                return;
            }
            state.isRolling = true;
            document.getElementById('roll-button').disabled = true;
            setBalance(getBalance() - state.betAmount);
            document.querySelectorAll('.cube__face').forEach(f => f.classList.remove('winner', 'loser'));

            const result = Math.floor(Math.random() * 6) + 1;
            const rots = { 1:{x:0,y:0}, 2:{x:0,y:180}, 3:{x:0,y:-90}, 4:{x:0,y:90}, 5:{x:-90,y:0}, 6:{x:90,y:0} };
            state.currentRotationX += 1440 + (rots[result].x - (state.currentRotationX % 360));
            state.currentRotationY += 1440 + (rots[result].y - (state.currentRotationY % 360));

            const jBox = document.getElementById('jump-box');
            jBox.style.transform = 'translateY(-180px) scale(1.1)';
            document.getElementById('shadow').style.transform = 'scale(0.3)';
            document.getElementById('cube').style.transform = `rotateX(${state.currentRotationX}deg) rotateY(${state.currentRotationY}deg)`;

            setTimeout(() => {
                jBox.style.transform = 'translateY(0) scale(1)';
                document.getElementById('shadow').style.transform = 'scale(1)';
            }, 750);

            setTimeout(() => {
                state.isRolling = false;
                document.getElementById('roll-button').disabled = false;
                const isEven = result % 2 === 0;
                const isWin = (isEven && state.winCondition === 'even') || (!isEven && state.winCondition === 'odd');

                if(isWin) {
                    document.querySelector(`.cube__face--${result}`).classList.add('winner');
                    setBalance(getBalance() + (state.betAmount * state.multiplier));
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    document.querySelector(`.cube__face--${result}`).classList.add('loser');
                    tg.HapticFeedback.notificationOccurred('error');
                }

                if(state.autoActive) {
                    let shouldStop = false;
                    if(state.autoMode === 'limit') {
                        const lType = document.getElementById('limit-type').value;
                        const lAmt = parseFloat(document.getElementById('limit-amount').value) || 0;
                        if(lType === 'profit' && getBalance() >= state.startBalance + lAmt) shouldStop = true;
                        if(lType === 'loss' && getBalance() <= state.startBalance - lAmt) shouldStop = true;
                    }
                    if(shouldStop || getBalance() < state.betAmount) stopAutoPlay();
                    else state.autoTimeout = setTimeout(executeRoll, 1000);
                }
            }, 1500);
        }

        // –ó–∞–ø—É—Å–∫
        window.onload = initTelegram;
