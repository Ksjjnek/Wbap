<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MineSlot WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #222; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; margin: 0 auto; background: #333; border: 2px solid #555; }
        .ui { position: absolute; bottom: 20px; width: 100%; text-align: center; }
        button { padding: 15px 30px; font-size: 18px; background: #5aab44; border: none; color: white; border-radius: 8px; cursor: pointer; }
        button:active { background: #3e7a2f; }
        #score { position: absolute; top: 10px; left: 10px; font-size: 20px; color: #ffcc00; }
    </style>
</head>
<body>
    <div id="score">Монеты: 0</div>
    <canvas id="gameCanvas"></canvas>
    <div class="ui">
        <button onclick="spin()">КОПАТЬ! (SPIN)</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight - 100;

        const COLS = 5;
        const ROWS = 8;
        const BLOCK_SIZE = canvas.width / COLS;
        let score = 0;

        // Типы блоков
        const TYPES = {
            AIR: 0,
            DIRT: { color: '#8B4513', hp: 1 },
            STONE: { color: '#808080', hp: 2 },
            CHEST: { color: '#FFD700', hp: 1 }
        };

        let grid = [];
        function initGrid() {
            grid = [];
            for (let r = 0; r < ROWS; r++) {
                grid[r] = [];
                for (let c = 0; c < COLS; c++) {
                    if (r === ROWS - 1) grid[r][c] = { ...TYPES.CHEST };
                    else grid[r][c] = Math.random() > 0.3 ? { ...TYPES.DIRT } : { ...TYPES.STONE };
                }
            }
        }

        let activePickaxes = [];

        function spin() {
            // Генерируем кирки в случайных колонках
            for (let c = 0; c < COLS; c++) {
                if (Math.random() > 0.5) {
                    activePickaxes.push({ x: c, y: -1, speed: 0.2 });
                }
            }
        }

        function update() {
            activePickaxes.forEach((pick, index) => {
                pick.y += pick.speed;
                let gridY = Math.floor(pick.y);
                
                if (gridY >= 0 && gridY < ROWS) {
                    let block = grid[gridY][pick.x];
                    if (block && block.hp > 0) {
                        block.hp--;
                        if (block.hp <= 0) {
                            if (gridY === ROWS - 1) { // Это сундук!
                                score += 100;
                                scoreEl.innerText = `Монеты: ${score}`;
                                tg.HapticFeedback.notificationOccurred('success');
                            }
                            // Блок разрушен, кирка летит дальше
                        } else {
                            // Кирка застряла на прочном блоке (удаляем её)
                            activePickaxes.splice(index, 1);
                        }
                    }
                }
                if (pick.y > ROWS) activePickaxes.splice(index, 1);
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем блоки
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    let block = grid[r][c];
                    if (block.hp > 0) {
                        ctx.fillStyle = block.color;
                        ctx.fillRect(c * BLOCK_SIZE + 2, r * BLOCK_SIZE + 2, BLOCK_SIZE - 4, BLOCK_SIZE - 4);
                        // Текстура трещин, если HP мало
                        if (block.hp === 1 && block.color === '#808080') {
                            ctx.fillStyle = 'black';
                            ctx.fillRect(c * BLOCK_SIZE + 10, r * BLOCK_SIZE + 10, 5, 5);
                        }
                    }
                }
            }

            // Рисуем летящие кирки
            ctx.fillStyle = '#00FFFF';
            activePickaxes.forEach(pick => {
                ctx.fillRect(pick.x * BLOCK_SIZE + BLOCK_SIZE/3, pick.y * BLOCK_SIZE, 10, 20);
            });

            update();
            requestAnimationFrame(draw);
        }

        initGrid();
        draw();
    </script>
</body>
</html>
