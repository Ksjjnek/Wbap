<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plinko Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --blue: #0a84ff; --green: #32d74b; --red: #ff453a; --gray: #2c2c2e; --orange: #ff9f0a; }
        body {
            margin: 0; background: #1c1c1e; color: white;
            font-family: -apple-system, sans-serif; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        /* –®–∞–ø–∫–∞ */
        .header { 
            width: 100%; padding: 10px 15px; display: flex; 
            justify-content: space-between; align-items: center; box-sizing: border-box; 
        }
        .profile { display: flex; align-items: center; background: var(--gray); padding: 4px 12px 4px 4px; border-radius: 25px; }
        .avatar { width: 30px; height: 30px; border-radius: 50%; background: #444; }
        .bal-val { margin-left: 8px; font-weight: bold; font-size: 13px; }

        .game-mode-btn {
            background: var(--blue); border: none; color: white; 
            padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;
        }

        /* –ü–æ–ª–µ */
        #game { width: 400px; height: 380px; position: relative; margin-top: -5px; }
        canvas { display: block; }

        .mults { display: flex; justify-content: center; gap: 4px; width: 400px; padding: 0 10px; box-sizing: border-box; }
        .m-tile {
            flex: 1; padding: 8px 0; border-radius: 4px; text-align: center; font-size: 10px;
            font-weight: bold; transition: 0.3s;
        }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–æ–π */
        .bet-control {
            display: flex; align-items: center; justify-content: center; 
            gap: 10px; margin: 15px 0 5px; width: 90%;
        }
        .bet-input-wrap {
            display: flex; align-items: center; background: var(--gray); 
            border-radius: 12px; padding: 5px 10px;
        }
        .bet-btn-small {
            background: none; border: none; color: var(--blue); 
            font-size: 24px; font-weight: bold; cursor: pointer; padding: 0 10px;
        }
        .bet-input {
            width: 60px; background: none; border: none; color: white; 
            text-align: center; font-size: 18px; font-weight: bold; outline: none;
        }
        
        .step-btn {
            background: var(--gray); border: 1px solid #444; color: #aaa;
            padding: 4px 8px; border-radius: 8px; font-size: 10px; margin-bottom: 10px;
        }

        .panel { width: 90%; display: flex; flex-direction: column; align-items: center; }
        .balls-grid { display: flex; justify-content: space-between; gap: 4px; width: 100%; margin-bottom: 10px; }
        .b-btn { flex: 1; background: var(--gray); border: none; color: white; padding: 10px 0; border-radius: 10px; font-size: 12px; font-weight: bold; }
        .b-btn.active { background: var(--green); }

        .play-btn { width: 100%; background: var(--green); border: none; color: white; padding: 16px; border-radius: 18px; font-size: 18px; font-weight: bold; }
        .cost-info { text-align: center; margin-top: 8px; color: var(--orange); font-size: 13px; font-weight: 700; }

        /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
        .float {
            position: fixed; pointer-events: none; font-weight: 900; z-index: 100;
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-80px) scale(1); opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="profile">
            <img id="avatar" src="" class="avatar">
            <div class="bal-val" id="top-bal">1000 ü™ô</div>
        </div>
        <button class="game-mode-btn" id="mode-toggle-btn" onclick="toggleGameMode()">–†–ï–ñ–ò–ú: –û–ë–´–ß–ù–´–ô</button>
    </div>

    <div class="toggle-box" style="display:none"> </div>

    <div id="game"></div>
    <div class="mults" id="mults-row"></div>

    <div class="panel">
        <div class="bet-control">
            <button class="bet-btn-small" onclick="adjustBet(-1)">‚àí</button>
            <div class="bet-input-wrap">
                <input type="text" class="bet-input" id="bet-field" value="10" oninput="validateInput(this)" onblur="checkMin(this)">
            </div>
            <button class="bet-btn-small" onclick="adjustBet(1)">+</button>
        </div>
        <button class="step-btn" id="step-display" onclick="toggleStep()">–®–ê–ì: 1</button>

        <div class="balls-grid">
            <button class="b-btn active" onclick="setB(1, this)">1</button>
            <button class="b-btn" onclick="setB(2, this)">2</button>
            <button class="b-btn" onclick="setB(5, this)">5</button>
            <button class="b-btn" onclick="setB(10, this)">10</button>
            <button class="b-btn" onclick="setB(25, this)">25</button>
            <button class="b-btn" onclick="setB(50, this)">50</button>
        </div>

        <button class="play-btn" onclick="play()">–ò–ì–†–ê–¢–¨</button>
        <div class="cost-info" id="warn">–°–ø–∏—à–µ—Ç—Å—è: 10 ü™ô</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let dBal = 1000, rBal = 0, mode = 'demo', balls = 1, bet = 10;
        let gameMode = 'normal'; // 'normal' –∏–ª–∏ 'insane'
        let betStep = 1;
        const steps = [0.5, 1, 2.5, 5, 10];
        let particles = [];

        const u = tg.initDataUnsafe?.user;
        document.getElementById('avatar').src = u?.photo_url || `https://ui-avatars.com/api/?name=${u?.first_name || 'U'}&background=32d74b&color=fff`;

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–æ–π
        function validateInput(el) {
            el.value = el.value.replace(/[^0-9.]/g, '');
            bet = parseFloat(el.value) || 0;
            updateUI();
        }
        function checkMin(el) {
            if (parseFloat(el.value) < 1 || el.value === "") { el.value = "1"; bet = 1; }
            updateUI();
        }
        function adjustBet(dir) {
            bet = Math.max(1, bet + (dir * betStep));
            document.getElementById('bet-field').value = bet;
            updateUI();
        }
        function toggleStep() {
            let idx = steps.indexOf(betStep);
            betStep = steps[(idx + 1) % steps.length];
            document.getElementById('step-display').innerText = `–®–ê–ì: ${betStep}`;
        }
        function toggleGameMode() {
            gameMode = gameMode === 'normal' ? 'insane' : 'normal';
            document.getElementById('mode-toggle-btn').innerText = `–†–ï–ñ–ò–ú: ${gameMode === 'normal' ? '–û–ë–´–ß–ù–´–ô' : '–ë–ï–ó–£–ú–ù–´–ô'}`;
            document.getElementById('mode-toggle-btn').style.background = gameMode === 'normal' ? 'var(--blue)' : 'var(--red)';
        }

        function updateUI() {
            document.getElementById('top-bal').innerText = `${Math.floor(dBal)} ü™ô`;
            document.getElementById('warn').innerText = `–°–ø–∏—à–µ—Ç—Å—è: ${(balls * bet).toFixed(1)} ü™ô`;
        }

        function setB(n, el) { 
            balls = n; 
            document.querySelectorAll('.b-btn').forEach(x => x.classList.remove('active')); 
            el.classList.add('active'); 
            updateUI(); 
        }

        // –§–∏–∑–∏–∫–∞
        const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;
        const eng = Engine.create();
        const ren = Render.create({ 
            element: document.getElementById('game'), 
            engine: eng, 
            options: { width: 400, height: 380, wireframes: false, background: 'transparent' } 
        });

        const conf = [
            {l:'0x', v:0, c:'#444'}, {l:'0.5x', v:0.5, c:'#ff9f0a'}, {l:'1.5x', v:1.5, c:'#ff9f0a'},
            {l:'10x', v:10, c:'#32d74b'}, {l:'3x', v:3, c:'#ff9f0a'}, {l:'1x', v:1, c:'#ffd60a'}, {l:'0x', v:0, c:'#444'}
        ];

        const CAT_BALL = 0x0002, CAT_STATIC = 0x0001;

        // –õ—É–Ω–∫–∏ –∏ —Å–µ–Ω—Å–æ—Ä—ã
        conf.forEach((m, i) => {
            const d = document.createElement('div');
            d.className = 'm-tile'; d.innerText = m.l; d.style.background = m.c;
            document.getElementById('mults-row').appendChild(d);
            const s = Bodies.rectangle(65 + i*45, 370, 35, 10, { isStatic: true, isSensor: true, label: 's_'+i, render: {visible: false} });
            Composite.add(eng.world, s);
            const wall = Bodies.rectangle(43 + i*45, 355, 2, 30, { isStatic: true, render: {fillStyle: '#333'} });
            Composite.add(eng.world, wall);
        });
        Composite.add(eng.world, Bodies.rectangle(43 + 7*45, 355, 2, 30, { isStatic: true, render: {fillStyle: '#333'} }));

        // –¢–æ–Ω–∫–∏–µ –±–æ—Ä—Ç–∏–∫–∏
        Composite.add(eng.world, [
            Bodies.rectangle(5, 190, 2, 320, { isStatic: true, render: {fillStyle: '#555'} }),
            Bodies.rectangle(395, 190, 2, 320, { isStatic: true, render: {fillStyle: '#555'} })
        ]);

        // –ü–∏–Ω—ã: –Ω–∞—á–∞–ª–æ —Å 3-—Ö —à—Ç—É–∫, –∏–¥–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞
        const startRows = 3;
        const maxRows = 10;
        const spacingX = 36;
        const spacingY = 30;

        for(let i = 0; i < (maxRows - startRows + 1); i++) {
            let pinsInRow = startRows + i;
            let rowWidth = (pinsInRow - 1) * spacingX;
            let startX = 200 - (rowWidth / 2);
            for(let j = 0; j < pinsInRow; j++) {
                Composite.add(eng.world, Bodies.circle(startX + j*spacingX, 60 + (i*spacingY), 3, { 
                    isStatic: true, label: 'peg', collisionFilter: { category: CAT_STATIC },
                    render: { fillStyle: '#fff' } 
                }));
            }
        }

        Events.on(eng, 'collisionStart', e => {
            e.pairs.forEach(p => {
                const b = p.bodyA.label === 'b' ? p.bodyA : (p.bodyB.label === 'b' ? p.bodyB : null);
                const s = p.bodyA.label.startsWith('s_') ? p.bodyA : (p.bodyB.label.startsWith('s_') ? p.bodyB : null);
                const peg = p.bodyA.label === 'peg' ? p.bodyA : (p.bodyB.label === 'peg' ? p.bodyB : null);

                if(b && peg && !b.actionTaken) {
                    b.actionTaken = true;
                    if(gameMode === 'normal' && Math.random() < 0.10) {
                        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: 10% —à–∞–Ω—Å –Ω–∞ —Å–ª–∞–±—ã–π –æ—Ç—Å–∫–æ–∫
                        Body.setVelocity(b, { x: b.velocity.x * 0.2, y: 1 });
                    } else if(gameMode === 'insane' && Math.random() < 0.10) {
                        // –ë–µ–∑—É–º–Ω—ã–π —Ä–µ–∂–∏–º: 10% —à–∞–Ω—Å –Ω–∞ –º–æ—â–Ω—ã–π –ø–æ–¥–±—Ä–æ—Å
                        Body.setVelocity(b, { x: (Math.random()-0.5)*15, y: -10 });
                        b.render.fillStyle = '#ffcc00';
                    }
                }

                if(b && s) {
                    const m = conf[s.label.split('_')[1]];
                    const win = b.bet * m.v;
                    dBal += win;
                    spawnText(s.position.x, 330, win, m.v);
                    updateUI();
                    Composite.remove(eng.world, b);
                }
            });
        });

        function spawnText(x, y, v, m) {
            const el = document.createElement('div');
            el.className = 'float';
            el.innerText = m > 1 ? `+${v.toFixed(1)}` : (m < 1 ? `-${(bet-v).toFixed(1)}` : `1x`);
            el.style.color = m > 1 ? 'var(--green)' : (m < 1 ? 'var(--red)' : '#fff');
            el.style.left = x + 'px'; el.style.top = (y + 40) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        Render.run(ren);
        Runner.run(Runner.create(), eng);

        function play() {
            const total = balls * bet;
            if(dBal < total) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
            dBal -= total; updateUI();
            for(let i=0; i<balls; i++) {
                setTimeout(() => {
                    const ball = Bodies.circle(200 + (Math.random()*4-2), 15, 5, { 
                        restitution: 0.5, friction: 0.01, label: 'b',
                        collisionFilter: { category: CAT_BALL, mask: CAT_STATIC },
                        render: { fillStyle: '#ff3b30' } 
                    });
                    ball.bet = bet; ball.actionTaken = false;
                    Composite.add(eng.world, ball);
                }, i * 120);
            }
        }
        updateUI();
    </script>
</body>
</html>
