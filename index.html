<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Plinko Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    
    <style>
        body {
            margin: 0; padding: 0; background-color: #1c1c1e; color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π (–°–≤–∏—Ç—á–µ—Ä—ã) */
        .toggle-container {
            position: relative; width: 80%; background: #2c2c2e; border-radius: 25px;
            display: flex; margin: 15px 0; padding: 5px; box-sizing: border-box;
        }
        .toggle-btn {
            flex: 1; text-align: center; padding: 10px; z-index: 2; cursor: pointer;
            font-weight: bold; font-size: 14px; transition: color 0.3s;
        }
        .toggle-slider {
            position: absolute; top: 5px; left: 5px; width: calc(50% - 5px); height: calc(100% - 10px);
            background: #0a84ff; border-radius: 20px; transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); z-index: 1;
        }
        .demo-mode .toggle-slider { transform: translateX(0); }
        .balance-mode .toggle-slider { transform: translateX(100%); }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        #game-container { position: relative; width: 100%; max-width: 400px; height: 350px; }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ (–ü—Ä–∏–∑–æ–≤—ã–µ –º–µ—Å—Ç–∞) */
        .multipliers {
            display: flex; justify-content: space-between; width: 100%; max-width: 400px;
            padding: 0 10px; box-sizing: border-box; margin-top: -20px; z-index: 10;
        }
        .multiplier {
            background: #ff9f0a; padding: 5px; border-radius: 5px; font-size: 12px; font-weight: bold;
            opacity: 0; transform: translateY(10px); transition: all 0.5s ease;
        }
        .multiplier.show { opacity: 1; transform: translateY(0); }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { width: 90%; max-width: 400px; margin-top: 20px; text-align: center; }
        .btn-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .btn-row button {
            background: #3a3a3c; border: none; color: white; padding: 10px 15px;
            border-radius: 10px; cursor: pointer; font-size: 14px;
        }
        .btn-row button.active { background: #32d74b; }
        
        .play-btn {
            width: 100%; background: #32d74b; color: #fff; border: none;
            padding: 15px; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer;
        }
        .cost-display { margin-top: 10px; font-size: 14px; color: #8e8e93; }
    </style>
</head>
<body>

    <div class="toggle-container demo-mode" id="mode-toggle">
        <div class="toggle-slider"></div>
        <div class="toggle-btn" onclick="setMode('demo')">–î–µ–º–æ</div>
        <div class="toggle-btn" onclick="setMode('balance')">–ë–∞–ª–∞–Ω—Å</div>
    </div>

    <div id="game-container"></div>
    
    <div class="multipliers" id="multipliers-container">
        </div>

    <div class="controls">
        <p style="margin: 0 0 5px 0; font-size: 12px; color: #8e8e93;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–∏–∫–æ–≤:</p>
        <div class="btn-row" id="balls-row">
            <button class="active" onclick="setBalls(1, this)">1</button>
            <button onclick="setBalls(2, this)">2</button>
            <button onclick="setBalls(5, this)">5</button>
            <button onclick="setBalls(10, this)">10</button>
            <button onclick="setBalls(25, this)">25</button>
            <button onclick="setBalls(50, this)">50</button>
        </div>

        <p style="margin: 10px 0 5px 0; font-size: 12px; color: #8e8e93;">–°—Ç–∞–≤–∫–∞:</p>
        <div class="toggle-container demo-mode" id="bet-toggle">
            <div class="toggle-slider"></div>
            <div class="toggle-btn" onclick="setBet(10, this)">10 ü™ô</div>
            <div class="toggle-btn" onclick="setBet(100, this)">100 ü™ô</div>
        </div>

        <button class="play-btn" onclick="play()">–ò–ì–†–ê–¢–¨</button>
        <div class="cost-display" id="total-cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 10 ü™ô</div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();

        let currentMode = 'demo';
        let ballsCount = 1;
        let betAmount = 10;

        // UI –§—É–Ω–∫—Ü–∏–∏
        function setMode(mode) {
            currentMode = mode;
            const toggle = document.getElementById('mode-toggle');
            if (mode === 'demo') { toggle.classList.replace('balance-mode', 'demo-mode'); } 
            else { toggle.classList.replace('demo-mode', 'balance-mode'); }
            updateCost();
        }

        function setBalls(count, btn) {
            ballsCount = count;
            document.querySelectorAll('#balls-row button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateCost();
        }

        function setBet(amount, btn) {
            betAmount = amount;
            const toggle = document.getElementById('bet-toggle');
            if (amount === 10) { toggle.classList.replace('balance-mode', 'demo-mode'); } 
            else { toggle.classList.replace('demo-mode', 'balance-mode'); }
            updateCost();
        }

        function updateCost() {
            const total = ballsCount * betAmount;
            const currency = currentMode === 'demo' ? '–î–µ–º–æ-–º–æ–Ω–µ—Ç' : 'USDT';
            document.getElementById('total-cost').innerText = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${total} ${currency}`;
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π
        const mults = ['10x', '3x', '1.5x', '0.5x', '1.5x', '3x', '10x'];
        const multContainer = document.getElementById('multipliers-container');
        mults.forEach((m, i) => {
            let el = document.createElement('div');
            el.className = 'multiplier';
            el.innerText = m;
            multContainer.appendChild(el);
            // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => el.classList.add('show'), 500 + (i * 100));
        });

        // --- –§–∏–∑–∏–∫–∞ –∏–≥—Ä—ã (Matter.js) ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite;

        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: { width: 400, height: 350, wireframes: false, background: 'transparent' }
        });

        // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ (pegs)
        const pegs = [];
        const rows = 8;
        for (let i = 2; i < rows; i++) {
            for (let j = 0; j <= i; j++) {
                let x = 200 + (j * 40) - (i * 20);
                let y = 50 + (i * 35);
                pegs.push(Bodies.circle(x, y, 4, { isStatic: true, render: { fillStyle: '#ffffff' } }));
            }
        }
        Composite.add(engine.world, pegs);

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // –§—É–Ω–∫—Ü–∏—è –±—Ä–æ—Å–∫–∞ —à–∞—Ä–∏–∫–∞
        function play() {
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º "–ë–∞–ª–∞–Ω—Å", –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã
            if (currentMode === 'balance') {
                tg.sendData(JSON.stringify({ action: 'pay', amount: ballsCount * betAmount }));
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —à–∞—Ä–∏–∫–∏ –Ω–µ –ø–∞–¥–∞—é—Ç –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã!
            }

            for (let i = 0; i < ballsCount; i++) {
                setTimeout(() => {
                    // –ù–µ–±–æ–ª—å—à–æ–π —Ä–∞–Ω–¥–æ–º –ø—Ä–∏ —Å–ø–∞–≤–Ω–µ
                    let xOffset = 200 + (Math.random() * 10 - 5);
                    let ball = Bodies.circle(xOffset, 10, 8, { 
                        restitution: 0.8, // –û—Ç—Å–∫–æ–∫
                        render: { fillStyle: '#ff3b30' } 
                    });
                    Composite.add(engine.world, ball);
                    
                    // –£–¥–∞–ª—è–µ–º —à–∞—Ä–∏–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –ø–∞–º—è—Ç—å)
                    setTimeout(() => { Composite.remove(engine.world, ball); }, 5000);
                }, i * 200); // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —à–∞—Ä–∏–∫–∞–º–∏
            }
        }
    </script>
</body>
</html>
