<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MineSlot Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #1e1e1e; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        canvas { display: block; image-rendering: pixelated; }
        .ui-panel {
            position: absolute; bottom: 0; width: 100%; height: 120px;
            background: #333; border-top: 4px solid #000;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-mine {
            width: 80%; height: 60px; background: #555; color: #fff;
            border: 4px solid #000; font-size: 24px; font-weight: bold;
            box-shadow: inset -4px -4px #222, inset 4px 4px #888;
            cursor: pointer; active: transform: scale(0.95);
        }
        #score-board {
            position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.7);
            padding: 10px; border: 2px solid #fff; color: #55ff55; font-size: 20px;
        }
    </style>
</head>
<body>

<div id="score-board">SCORE: 0</div>
<canvas id="game"></canvas>
<div class="ui-panel">
    <button class="btn-mine" onclick="spawnPickaxes()">MINE!</button>
</div>

<script>
const tg = window.Telegram.WebApp;
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score-board');

let width, height, cellSize;
let score = 0;
let shake = 0;
const COLS = 5;
const ROWS = 7;

// --- ТЕКСТУРЫ (Base64 для быстрой работы) ---
const TEXTURES = {
    DIRT: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMUlEQVQ4T2N88eLffwY0wNjYyIghMIGBAnD8j6EAbAbMIGwG4DMIWwaMpqDRFBAZCAD67R0LidmUoQAAAABJRU5ErkJggg==',
    STONE: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2M8c+bMfwY0wNjYyIghMIGBAnD8j6EAbAbMAD6iGAsU6pSDAAAAAElFTkSuQmCC',
    PICK: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAYklEQVQ4T2NkoBAwUqifAWpAbGxs/0E0shgcY2h8uA2AmYDNAGwG4DMIWwaMpqDRFBAZCAD67R0LidmUoQAAAABJRU5ErkJggg==',
};

const images = {};
Object.keys(TEXTURES).forEach(k => {
    images[k] = new Image();
    images[k].src = TEXTURES[k];
});

let grid = [];
let picks = [];
let particles = [];

function initGrid() {
    grid = [];
    for(let r=0; r<ROWS; r++) {
        grid[r] = [];
        for(let c=0; c<COLS; c++) {
            grid[r][c] = createBlock(r);
        }
    }
}

function createBlock(r) {
    let type = (Math.random() > 0.8) ? 'STONE' : 'DIRT';
    if(r === ROWS - 1) type = 'CHEST'; 
    return { type, hp: (type === 'STONE' ? 2 : 1), active: true };
}

function spawnPickaxes() {
    tg.HapticFeedback.impactOccurred('rigid');
    for(let c=0; c<COLS; c++) {
        if(Math.random() > 0.5) {
            picks.push({ x: c, y: -1, speed: 0.12 });
        }
    }
}

function update() {
    if(shake > 0) shake *= 0.8;

    // Движение кирок
    picks.forEach((p, i) => {
        p.y += p.speed;
        let r = Math.floor(p.y);
        if(grid[r] && grid[r][p.x] && grid[r][p.x].active) {
            let b = grid[r][p.x];
            b.hp--;
            createExplosion(p.x * cellSize + cellSize/2, r * cellSize + cellSize/2);
            if(b.hp <= 0) {
                b.active = false;
                score += 10;
                scoreEl.innerText = `SCORE: ${score}`;
            }
            picks.splice(i, 1);
        }
        if(p.y > ROWS) picks.splice(i, 1);
    });

    // Частицы
    particles.forEach((pt, i) => {
        pt.x += pt.vx; pt.y += pt.vy; pt.life -= 0.05;
        if(pt.life <= 0) particles.splice(i, 1);
    });

    // Рестарт/Генерация новых блоков при прохождении
    let rowFilled = grid[ROWS-1].every(b => !b.active);
    if(rowFilled) {
        grid.pop();
        grid.unshift(Array.from({length: COLS}, () => createBlock(0)));
        shake = 10;
    }
}

function createExplosion(x, y) {
    for(let i=0; i<6; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8,
            life: 1.0
        });
    }
}

function draw() {
    ctx.clearRect(0, 0, width, height);
    ctx.save();
    if(shake > 0.5) ctx.translate(Math.random()*shake, Math.random()*shake);

    for(let r=0; r<ROWS; r++) {
        for(let c=0; c<COLS; c++) {
            let b = grid[r][c];
            if(!b.active) continue;
            
            // Рисуем блок (Пикселизированный)
            ctx.fillStyle = b.type === 'STONE' ? '#777' : (b.type === 'CHEST' ? '#f1c40f' : '#8B4513');
            ctx.fillRect(c*cellSize+2, r*cellSize+2, cellSize-4, cellSize-4);
            
            // Добавляем "текстуру" вручную
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(c*cellSize+cellSize-15, r*cellSize+cellSize-15, 10, 10);
        }
    }

    // Рисуем кирки (нормальная иконка)
    picks.forEach(p => {
        ctx.fillStyle = '#fff';
        ctx.fillRect(p.x * cellSize + cellSize/2 - 5, p.y * cellSize, 10, 30); // Ручка
        ctx.fillStyle = '#00ffff';
        ctx.fillRect(p.x * cellSize + cellSize/2 - 20, p.y * cellSize, 40, 10); // Лезвие
    });

    // Рисуем частицы
    particles.forEach(pt => {
        ctx.globalAlpha = pt.life;
        ctx.fillStyle = '#fff';
        ctx.fillRect(pt.x, pt.y, 4, 4);
    });

    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight - 120;
    cellSize = width / COLS;
}

window.onresize = resize;
resize();
initGrid();
draw();
</script>
</body>
</html>
