<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plinko: Clean & Chaos</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { 
            --blue: #007aff; --green: #34c759; --red: #ff3b30; --purple: #af52de; --orange: #ff9500;
            --bg: #ffffff; --text: #000000; --panel: #f2f2f7; --pin: #8e8e93;
        }
        body.dark-mode { 
            --bg: #121214; --text: #ffffff; --panel: #2c2c2e; --pin: #ffffff;
        }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; transition: background 0.3s; }
        
        /* –®–∞–ø–∫–∞ */
        .header { width: 100%; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .profile { display: flex; align-items: center; background: var(--panel); padding: 5px 12px 5px 5px; border-radius: 20px; }
        .avatar { width: 30px; height: 30px; border-radius: 50%; background: #ccc; object-fit: cover; }
        .bal-val { margin-left: 8px; font-weight: bold; font-size: 14px; }
        
        .mode-btn { background: var(--blue); border: none; color: white; padding: 8px 15px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* –ü–æ–ª–µ */
        #game { width: 400px; height: 380px; position: relative; }
        .portal { position: absolute; border-radius: 50%; border: 2px dashed var(--purple); animation: rotate 2s linear infinite; opacity: 0.6; pointer-events: none; display: none; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .mults { display: flex; justify-content: center; width: 400px; padding: 0 12px; box-sizing: border-box; }
        .m-tile { flex: 1; margin: 0 2px; padding: 8px 0; border-radius: 4px; text-align: center; font-size: 10px; font-weight: bold; color: white; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        .ui-panel { width: 90%; display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 15px; }
        .bet-box { display: flex; align-items: center; gap: 15px; background: var(--panel); padding: 8px 15px; border-radius: 20px; }
        .bet-input { width: 60px; background: none; border: none; color: var(--text); text-align: center; font-size: 18px; font-weight: bold; outline: none; }
        .circle-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: #ddd; color: black; font-size: 18px; font-weight: bold; }
        body.dark-mode .circle-btn { background: #444; color: white; }

        .play-btn { width: 100%; background: var(--green); border: none; color: white; padding: 16px; border-radius: 18px; font-size: 18px; font-weight: bold; transition: 0.2s; }
        .play-btn:active { transform: scale(0.98); }
        .play-btn.locked { background: #8e8e93; opacity: 0.5; }

        #volcano-cutscene {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="profile">
            <img id="avatar" src="" class="avatar">
            <div class="bal-val" id="bal-display">1000 ü™ô</div>
        </div>
        <button class="mode-btn" id="mode-toggle" onclick="toggleMode()">–û–ë–´–ß–ù–´–ô</button>
    </div>

    <div id="game">
        <div id="portal-l" class="portal" style="width:40px; height:40px; left:80px; top:180px;"></div>
        <div id="portal-r" class="portal" style="width:40px; height:40px; right:80px; top:180px;"></div>
    </div>
    
    <div class="mults" id="mults-row"></div>

    <div class="ui-panel">
        <div class="bet-box">
            <button class="circle-btn" onclick="modifyBet(-1)">‚àí</button>
            <input type="text" id="bet-field" class="bet-input" value="10" oninput="validateInput(this)">
            <button class="circle-btn" onclick="modifyBet(1)">+</button>
        </div>
        <button class="mode-btn" style="background:var(--panel); color:var(--text); font-size:10px" id="step-btn" onclick="cycleStep()">–®–ê–ì: 1</button>
        
        <div id="balls-row" style="display:flex; gap:5px; width:100%"></div>

        <button class="play-btn" id="main-play" onclick="handlePlay()">–ò–ì–†–ê–¢–¨</button>
        <div id="cost-label" style="font-size:12px; font-weight:bold; color:var(--orange)">–°–ø–∏—à–µ—Ç—Å—è: 10 ü™ô</div>
    </div>

    <div id="volcano-cutscene">
        <h1 style="color:var(--red); font-size:40px">üåã –í–£–õ–ö–ê–ù!</h1>
        <p style="color:white">–ü–æ–≥–ª–æ—â–µ–Ω–∏–µ –ø—Ä–æ–∏–≥—Ä—ã—à–µ–π...</p>
        <h2 style="color:var(--orange); font-size:50px">80x!</h2>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let dBal = 1000, bet = 10, step = 1, ballsCount = 1, isInsane = false;
        let zeroCounter = 0, isLock = false;
        const steps = [0.5, 1, 2.5, 5, 10];
        
        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ Ghost-—à–∞—Ä–∞
        const CAT_BALL = 0x0002, CAT_PIN = 0x0004, CAT_SENSOR = 0x0008, CAT_WALL = 0x0001;

        const conf = [
            {l:'10x', v:10, c: '#ff3b30'}, {l:'2x', v:2, c: '#ff9500'}, {l:'0.5x', v:0.5, c: '#ffcc00'},
            {l:'0x', v:0, c: '#8e8e93'}, 
            {l:'0.5x', v:0.5, c: '#ffcc00'}, {l:'2x', v:2, c: '#ff9500'}, {l:'10x', v:10, c: '#ff3b30'}
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —é–∑–µ—Ä–∞
        const u = tg.initDataUnsafe?.user;
        document.getElementById('avatar').src = u?.photo_url || `https://ui-avatars.com/api/?name=${u?.first_name || 'U'}&background=007aff&color=fff`;

        function updateUI() {
            if(dBal < 100) dBal = 100; // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ —É–ø–∞–ª –Ω–∏–∂–µ 100
            document.getElementById('bal-display').innerText = `${Math.floor(dBal)} ü™ô`;
            document.getElementById('cost-label').innerText = `–°–ø–∏—à–µ—Ç—Å—è: ${(ballsCount * bet).toFixed(1)} ü™ô`;
            document.getElementById('main-play').classList.toggle('locked', isLock);
        }

        function toggleMode() {
            isInsane = !isInsane;
            document.body.classList.toggle('dark-mode', isInsane);
            const btn = document.getElementById('mode-toggle');
            btn.innerText = isInsane ? "–ë–ï–ó–£–ú–ù–´–ô" : "–û–ë–´–ß–ù–´–ô";
            btn.style.background = isInsane ? "var(--red)" : "var(--blue)";
            document.getElementById('portal-l').style.display = isInsane ? 'block' : 'none';
            document.getElementById('portal-r').style.display = isInsane ? 'block' : 'none';
        }

        function validateInput(i) { i.value = i.value.replace(/[^0-9.]/g,''); bet = parseFloat(i.value)||1; updateUI(); }
        function modifyBet(d) { bet = Math.max(1, bet + d*step); document.getElementById('bet-field').value = bet; updateUI(); }
        function cycleStep() { step = steps[(steps.indexOf(step)+1)%steps.length]; document.getElementById('step-btn').innerText = `–®–ê–ì: ${step}`; }

        // MATTER JS
        const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;
        const engine = Engine.create();
        const render = Render.create({ 
            element: document.getElementById('game'), 
            engine: engine, 
            options: { width: 400, height: 380, wireframes: false, background: 'transparent' } 
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –ª—É–Ω–æ–∫ (—Ä–æ–≤–Ω–æ –ø–æ –±–æ—Ä—Ç–∏–∫—É)
        conf.forEach((m, i) => {
            const tile = document.createElement('div');
            tile.className = 'm-tile'; tile.innerText = m.l; tile.style.background = m.c;
            document.getElementById('mults-row').appendChild(tile);
            
            const x = 50 + i * 50; 
            const sensor = Bodies.rectangle(x, 372, 40, 10, { 
                isStatic: true, isSensor: true, label: 's_'+i,
                collisionFilter: { category: CAT_SENSOR },
                render: { visible: false }
            });
            const lWall = Bodies.rectangle(x-25, 355, 2, 40, { isStatic: true, render: {fillStyle: '#444'} });
            const rWall = Bodies.rectangle(x+25, 355, 2, 40, { isStatic: true, render: {fillStyle: '#444'} });
            Composite.add(engine.world, [sensor, lWall, rWall]);
        });

        // –ì—Ä–∞–Ω–∏—Ü—ã –º–∏—Ä–∞
        Composite.add(engine.world, [
            Bodies.rectangle(2, 190, 4, 380, { isStatic: true, collisionFilter: {category: CAT_WALL}, render: {fillStyle: '#444'} }),
            Bodies.rectangle(398, 190, 4, 380, { isStatic: true, collisionFilter: {category: CAT_WALL}, render: {fillStyle: '#444'} })
        ]);

        // –ü–æ—Ä—Ç–∞–ª—ã
        const pL = Bodies.circle(80, 180, 20, { isStatic: true, isSensor: true, label: 'port' });
        const pR = Bodies.circle(320, 180, 20, { isStatic: true, isSensor: true, label: 'port' });
        Composite.add(engine.world, [pL, pR]);

        // –ü–∏–Ω—ã (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 3-—Ö)
        for(let i=0; i<10; i++) {
            let cnt = 3 + i;
            let sx = 200 - ((cnt-1)*36)/2;
            for(let j=0; j<cnt; j++) {
                Composite.add(engine.world, Bodies.circle(sx + j*36, 60 + i*30, 3, { 
                    isStatic: true, label: 'peg', 
                    collisionFilter: { category: CAT_PIN },
                    render: { fillStyle: '#8e8e93' } 
                }));
            }
        }

        Events.on(engine, 'collisionStart', e => {
            e.pairs.forEach(p => {
                const b = p.bodyA.label === 'b' ? p.bodyA : (p.bodyB.label === 'b' ? p.bodyB : null);
                const s = p.bodyA.label.startsWith('s_') ? p.bodyA : (p.bodyB.label.startsWith('s_') ? p.bodyB : null);
                const peg = p.bodyA.label === 'peg' || p.bodyB.label === 'peg';
                const port = p.bodyA.label === 'port' || p.bodyB.label === 'port';

                if(b && peg) {
                    b.bHits++;
                    // –û–ë–´–ß–ù–´–ô: 10% —à–∞–Ω—Å –Ω–∞ —Å–ª–∞–±—ã–π –æ—Ç—Å–∫–æ–∫
                    if(!isInsane && !b.didSpecial && Math.random() < 0.10) {
                        b.didSpecial = true;
                        Body.setVelocity(b, { x: b.velocity.x * 0.1, y: 1.5 });
                        b.render.fillStyle = '#ffcc00';
                    }
                    // –ë–ï–ó–£–ú–ù–´–ô: Ghost Mode –Ω–∞ 3-–º —É–¥–∞—Ä–µ
                    if(isInsane && b.bHits === 3) {
                        b.isGhost = true;
                        b.render.fillStyle = '#af52de'; b.render.opacity = 0.5;
                        // –ú–∞–≥–∏—è —Ñ–∏–ª—å—Ç—Ä–∞: —Ç–µ–ø–µ—Ä—å —à–∞—Ä –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –ü–ò–ù–´, –Ω–æ –≤–∏–¥–∏—Ç –°–¢–ï–ù–´ –∏ –°–ï–ù–°–û–†–´
                        b.collisionFilter.mask = CAT_WALL | CAT_SENSOR;
                        setTimeout(() => {
                            if(!b) return;
                            b.isGhost = false; b.render.opacity = 1; b.render.fillStyle = b.originColor;
                            b.collisionFilter.mask = CAT_WALL | CAT_SENSOR | CAT_PIN;
                        }, 1500);
                    }
                }

                if(b && port && isInsane) {
                    const dest = Math.random() < 0.8 ? 200 : (Math.random() < 0.5 ? 50 : 350);
                    Body.setPosition(b, { x: dest, y: 340 });
                }

                if(b && s) {
                    const m = conf[s.label.split('_')[1]];
                    let win = b.bet * m.v;
                    if(m.v === 0) zeroCounter++; else zeroCounter = 0;
                    
                    if(zeroCounter >= 25 && Math.random() < 0.05 && !isLock) {
                        triggerVolcano(); win = b.bet * 80;
                    }
                    dBal += win; updateUI();
                    Composite.remove(engine.world, b);
                }
            });
        });

        // –≠—Ñ—Ñ–µ–∫—Ç —à–ª–µ–π—Ñ–∞
        Events.on(render, 'afterRender', () => {
            const ctx = render.context;
            Composite.allBodies(engine.world).forEach(b => {
                if(b.isGhost) {
                    if(!b.trail) b.trail = [];
                    b.trail.push({x: b.position.x, y: b.position.y});
                    if(b.trail.length > 6) b.trail.shift();
                    b.trail.forEach((t, i) => {
                        ctx.beginPath(); ctx.arc(t.x, t.y, 4, 0, Math.PI*2);
                        ctx.fillStyle = `rgba(175, 82, 222, ${i/10})`; ctx.fill();
                    });
                }
            });
        });

        function triggerVolcano() {
            isLock = true; updateUI();
            const cut = document.getElementById('volcano-cutscene');
            cut.style.display = 'flex';
            setTimeout(() => { cut.style.display = 'none'; isLock = false; zeroCounter = 0; updateUI(); }, 3500);
        }

        function handlePlay() {
            if(isLock || dBal < bet * ballsCount) return;
            dBal -= bet * ballsCount; updateUI();
            for(let i=0; i<ballsCount; i++) {
                setTimeout(() => {
                    const ball = Bodies.circle(200 + (Math.random()*4-2), 20, 5, {
                        restitution: 0.5, friction: 0.01, label: 'b',
                        collisionFilter: { category: CAT_BALL, mask: CAT_WALL | CAT_SENSOR | CAT_PIN },
                        render: { fillStyle: isInsane ? '#ff3b30' : '#007aff' }
                    });
                    ball.bet = bet; ball.bHits = 0; ball.originColor = ball.render.fillStyle;
                    Composite.add(engine.world, ball);
                }, i*100);
            }
        }

        // –†—è–¥ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —à–∞—Ä–æ–≤
        [1, 5, 10, 25, 50].forEach(n => {
            const btn = document.createElement('button');
            btn.className = 'mode-btn'; btn.style.flex = "1"; btn.style.background = "var(--panel)"; btn.style.color = "var(--text)"; btn.innerText = n;
            btn.onclick = () => { ballsCount = n; updateUI(); };
            document.getElementById('balls-row').appendChild(btn);
        });

        Render.run(render); Runner.run(Runner.create(), engine);
        updateUI();
    </script>
</body>
</html>
