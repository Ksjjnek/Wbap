<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dice Pro VIP & Balloon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --glass: rgba(20, 20, 20, 0.6);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #4ade80;
            --danger: #ff4757;
            --demo: #a78bfa;
            --blue: #3b82f6;
        }

        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', sans-serif; color: white; user-select: none; }
        
        /* === –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ === */
        #top-bar { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .nav-left { display: flex; flex-direction: row; gap: 8px; align-items: center; }
        #btn-back { display: none; width: 40px; height: 40px; border-radius: 50%; background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--border); color: white; font-size: 20px; font-weight: 900; cursor: pointer; align-items: center; justify-content: center; }
        .glass-pill { background: var(--glass); backdrop-filter: blur(15px); padding: 6px 14px; border-radius: 40px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .glass-pill:active { transform: scale(0.95); }
        #user-photo { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); object-fit: cover; }
        #user-name { font-weight: 800; font-size: 13px; }
        .balance-wrapper { display: flex; align-items: center; gap: 6px; }
        #balance-container { text-align: right; padding: 6px 12px; }
        #balance-mode { font-size: 9px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }
        #balance-value { font-weight: 900; font-size: 14px; display: block; white-space: nowrap; }
        #btn-deposit { width: 34px; height: 34px; border-radius: 50%; background: var(--accent); color: #000; border: none; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        /* === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
        #toast { position: absolute; top: 90px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 10px 24px; border-radius: 30px; font-weight: 800; font-size: 14px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

        /* === –≠–ö–†–ê–ù–´ === */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg); z-index: 50; transition: 0.4s; }
        #game-screen, #balloon-screen { display: none; background: transparent; }
        #profile-screen { display: none; align-items: center; justify-content: center; z-index: 80; }

        /* === –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ === */
        #menu-screen { align-items: center; justify-content: center; z-index: 90; }
        .games-grid { display: flex; flex-direction: column; gap: 20px; width: 280px; }
        .game-card { width: 100%; background: linear-gradient(145deg, #1e1e1e, #111); border-radius: 32px; border: 1px solid var(--border); overflow: hidden; }
        .card-preview { height: 140px; background: #151515; display: flex; align-items: center; justify-content: center; font-size: 70px; }
        .card-info { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .play-btn { background: #fff; color: #000; border: none; padding: 12px 24px; border-radius: 20px; font-weight: 900; cursor: pointer; font-size: 14px; }

        /* === –ü–†–û–§–ò–õ–¨ === */
        .profile-card { width: 90%; max-width: 320px; background: #111; border-radius: 30px; padding: 30px; border: 1px solid var(--border); text-align: center; }
        .profile-card img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px; }
        .stat-box { background: #1a1a1a; padding: 15px; border-radius: 20px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* === –ö–£–ë–ò–ö –≠–ö–†–ê–ù === */
        #three-container { position: absolute; width: 100%; height: 100%; z-index: -1; }
        #dice-history { position: absolute; top: 75px; width: 100%; text-align: center; font-size: 14px; letter-spacing: 3px; z-index: 55; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        #result-display { position: absolute; top: 30%; width: 100%; text-align: center; pointer-events: none; opacity: 0; transform: scale(0.5); transition: 0.3s; }
        #result-display.show { opacity: 1; transform: scale(1); }
        #result-text { font-size: 70px; font-weight: 900; text-shadow: 0 0 30px rgba(255,255,255,0.2); }

        /* === –®–ê–†–ò–ö –≠–ö–†–ê–ù === */
        #balloon-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding-bottom: 80px; }
        #balloon-history { position: absolute; top: 75px; width: 100%; text-align: center; font-size: 14px; letter-spacing: 3px; z-index: 55; }
        #the-balloon { font-size: 80px; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: bottom center; text-shadow: 0 10px 30px rgba(255,0,0,0.3); }
        #balloon-mult { font-size: 40px; font-weight: 900; margin-top: 20px; color: #fff; transition: 0.2s; }

        /* === –ü–ê–ù–ï–õ–ò –ú–ï–ù–Æ (–û–ë–©–ï–ï) === */
        .ui-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 15, 15, 0.65); backdrop-filter: blur(25px);
            border-top: 1px solid var(--border); border-radius: 30px 30px 0 0;
            padding: 0 20px 30px; box-sizing: border-box; display: flex; flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 60;
        }
        .ui-panel.collapsed { transform: translateY(calc(100% - 60px)); }
        
        /* –•–µ–¥–µ—Ä –ø–∞–Ω–µ–ª–∏ (–°—Ç—Ä–µ–ª–∫–∞ + –ú–∏–Ω–∏-–∫–Ω–æ–ø–∫–∞) */
        .panel-header { width: 100%; height: 60px; display: flex; align-items: center; position: relative; }
        .panel-toggle { flex: 1; height: 100%; background: none; border: none; color: #888; font-size: 16px; cursor: pointer; outline: none; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .ui-panel:not(.collapsed) .panel-toggle { transform: rotate(180deg); }
        
        .mini-play-btn {
            position: absolute; right: 0; height: 40px; padding: 0 20px;
            border-radius: 14px; border: none; background: var(--accent); color: #000;
            font-size: 14px; font-weight: 900; cursor: pointer;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .ui-panel.collapsed .mini-play-btn { opacity: 1; pointer-events: all; }

        .ui-content { display: flex; flex-direction: column; gap: 15px; opacity: 1; transition: 0.3s; }
        .ui-panel.collapsed .ui-content { opacity: 0; pointer-events: none; }
        .locked { opacity: 0.4; pointer-events: none; }

        /* –°–µ—Ç–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ */
        .bet-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .bet-grid.sectors { grid-template-columns: repeat(3, 1fr); }
        .bet-grid.numbers { grid-template-columns: repeat(6, 1fr); }
        .choice-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 12px 0; border-radius: 14px; font-weight: 800; font-size: 13px; cursor: pointer; }
        .choice-btn.active { background: #fff; color: #000 !important; border-color: #fff; }
        .choice-btn.mult-1-9 { color: #a78bfa; } .choice-btn.mult-2-8 { color: #60a5fa; } .choice-btn.mult-4-5 { color: #facc15; }

        .bet-box { display: flex; align-items: center; background: rgba(0,0,0,0.4); border-radius: 20px; padding: 6px; border: 1px solid var(--border); }
        .bet-box button { width: 50px; height: 50px; border-radius: 15px; border: none; background: rgba(255,255,255,0.08); color: #fff; font-size: 24px; cursor: pointer; }
        .bet-box input { flex: 1; background: none; border: none; color: #fff; text-align: center; font-size: 20px; font-weight: 800; outline: none; }

        .sys-row { display: flex; gap: 10px; }
        .sys-btn { flex: 1; padding: 16px; border-radius: 18px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: #fff; font-weight: 800; cursor: pointer; }
        .sys-btn.active { border-color: #facc15; color: #facc15; background: rgba(250, 204, 21, 0.1); }
        
        .main-action-btn { width: 100%; padding: 20px; border-radius: 20px; border: none; background: var(--accent); color: #000; font-size: 18px; font-weight: 900; text-transform: uppercase; cursor: pointer; }

        /* === –ú–û–î–ê–õ–ö–ò === */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 300; display: none; align-items: center; justify-content: center; }
        .modal { background: #151515; padding: 30px; border-radius: 30px; width: 280px; text-align: center; border: 1px solid var(--border); }
        .modal input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 15px; border: none; background: #000; color: #fff; text-align: center; font-size: 20px; font-weight: 800; box-sizing: border-box; }
        .modal-btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 900; font-size: 15px; cursor: pointer; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div class="nav-left">
            <button id="btn-back">&lt;</button>
            <div class="glass-pill" id="btn-profile">
                <img id="user-photo" src="https://via.placeholder.com/100" alt="Avatar">
                <span id="user-name">–ò–≥—Ä–æ–∫</span>
            </div>
        </div>
        <div class="balance-wrapper">
            <div id="balance-container" class="glass-pill">
                <div>
                    <span id="balance-mode">–î–µ–º–æ –°—á–µ—Ç</span>
                    <span id="balance-value">1000 üç¨</span>
                </div>
            </div>
            <button id="btn-deposit">+</button>
        </div>
    </div>

    <div id="toast"></div>

    <div id="menu-screen" class="screen">
        <div class="games-grid">
            <div class="game-card">
                <div class="card-preview">üé≤</div>
                <div class="card-info">
                    <h2 style="margin: 0; font-size: 22px; font-weight: 900;">–ö—É–±–∏–∫</h2>
                    <button class="play-btn" onclick="openGame('dice')">–ò–≥—Ä–∞—Ç—å</button>
                </div>
            </div>
            <div class="game-card">
                <div class="card-preview" style="font-size: 70px;">üéà</div>
                <div class="card-info">
                    <h2 style="margin: 0; font-size: 22px; font-weight: 900;">–®–∞—Ä–∏–∫</h2>
                    <button class="play-btn" onclick="openGame('balloon')">–ò–≥—Ä–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <div class="profile-card">
            <h2 style="margin-top:0;">–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h2>
            <img id="profile-img-large" src="https://via.placeholder.com/100" alt="">
            <h3 id="profile-name-large">–ò–≥—Ä–æ–∫</h3>
            
            <div class="stat-box">
                <span style="color:#aaa; font-weight:bold;">USDT –ë–∞–ª–∞–Ω—Å:</span>
                <span id="prof-real-bal" style="color:var(--accent); font-weight:900; font-size:18px;">0.00</span>
            </div>
            <div class="stat-box">
                <span style="color:#aaa; font-weight:bold;">–î–µ–º–æ –ë–∞–ª–∞–Ω—Å:</span>
                <span id="prof-demo-bal" style="color:var(--demo); font-weight:900; font-size:18px;">1000</span>
            </div>
            <button class="modal-btn" id="prof-deposit-btn" style="background:#fff; color:#000; margin-top: 20px;">–ü–û–ü–û–õ–ù–ò–¢–¨ USDT</button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="dice-history"></div>
        <div id="three-container"></div>
        <div id="result-display"><span id="result-text"></span></div>

        <div id="ui-panel-dice" class="ui-panel">
            <div class="panel-header">
                <button class="panel-toggle" onclick="document.getElementById('ui-panel-dice').classList.toggle('collapsed')">‚ñº</button>
                <button class="mini-play-btn" id="dice-mini-btn" onclick="btnRollClick()">–ò–ì–†–ê–¢–¨</button>
            </div>
            
            <div class="ui-content" id="dice-lock-zone">
                <div style="font-size: 11px; color: #888; font-weight: bold; margin-bottom: 5px;">–°–¢–ê–ù–î–ê–†–¢ (1.9x)</div>
                <div class="bet-grid">
                    <button class="choice-btn mult-1-9 active" data-cond="even">–ß–ï–¢</button>
                    <button class="choice-btn mult-1-9" data-cond="odd">–ù–ï–ß–ï–¢</button>
                    <button class="choice-btn mult-1-9" data-cond="gt3">> 3</button>
                    <button class="choice-btn mult-1-9" data-cond="lt4">< 4</button>
                </div>
                <div style="font-size: 11px; color: #888; font-weight: bold; margin-top: 10px; margin-bottom: 5px;">–°–ï–ö–¢–û–†–ê (2.8x)</div>
                <div class="bet-grid sectors">
                    <button class="choice-btn mult-2-8" data-cond="sec1">1 - 2</button>
                    <button class="choice-btn mult-2-8" data-cond="sec2">3 - 4</button>
                    <button class="choice-btn mult-2-8" data-cond="sec3">5 - 6</button>
                </div>
                <div style="font-size: 11px; color: #888; font-weight: bold; margin-top: 10px; margin-bottom: 5px;">–ß–ò–°–õ–û (4.5x)</div>
                <div class="bet-grid numbers">
                    <button class="choice-btn mult-4-5" data-cond="num1">1</button>
                    <button class="choice-btn mult-4-5" data-cond="num2">2</button>
                    <button class="choice-btn mult-4-5" data-cond="num3">3</button>
                    <button class="choice-btn mult-4-5" data-cond="num4">4</button>
                    <button class="choice-btn mult-4-5" data-cond="num5">5</button>
                    <button class="choice-btn mult-4-5" data-cond="num6">6</button>
                </div>

                <div class="bet-box" style="margin-top: 15px;">
                    <button onclick="changeBet(false)">‚àí</button>
                    <input type="number" id="bet-val" step="0.05">
                    <button onclick="changeBet(true)">+</button>
                </div>

                <div class="sys-row" style="margin-top: 15px;">
                    <button class="sys-btn" id="fast-toggle">–ë–´–°–¢–†–û ‚ö°</button>
                    <button class="sys-btn" id="auto-open" style="flex: 0.3;">‚ò∞</button>
                </div>

                <button class="main-action-btn" id="dice-main-btn" onclick="btnRollClick()" style="margin-top: 15px;">–ë–†–û–°–ò–¢–¨ –ö–£–ë–ò–ö</button>
            </div>
        </div>
    </div>

    <div id="balloon-screen" class="screen">
        <div id="balloon-history"></div>
        <div id="balloon-area">
            <div id="the-balloon">üéà</div>
            <div id="balloon-mult">1.00x</div>
        </div>

        <div id="ui-panel-balloon" class="ui-panel">
            <div class="panel-header">
                <button class="panel-toggle" onclick="document.getElementById('ui-panel-balloon').classList.toggle('collapsed')">‚ñº</button>
                <button class="mini-play-btn" id="ball-mini-btn" onclick="handleBalloonAction()">–ò–ì–†–ê–¢–¨</button>
            </div>
            
            <div class="ui-content" id="balloon-lock-zone">
                <div style="font-size: 11px; color: #888; font-weight: bold; margin-bottom: 5px;">–í–´–ë–ï–†–ò–¢–ï –†–ò–°–ö (–ú–Ω–æ–∂–∏—Ç–µ–ª—å –∑–∞ –Ω–∞–¥—É–≤)</div>
                <div class="bet-grid sectors">
                    <button class="choice-btn risk-btn active" style="color:var(--accent)" data-risk="low">–ú–∞–ª—ã–π<br>(x1.2)</button>
                    <button class="choice-btn risk-btn" style="color:#facc15" data-risk="med">–°—Ä–µ–¥–Ω–∏–π<br>(x1.5)</button>
                    <button class="choice-btn risk-btn" style="color:var(--danger)" data-risk="high">–í—ã—Å–æ–∫–∏–π<br>(x2.0)</button>
                </div>

                <div class="bet-box" style="margin-top: 15px;">
                    <button onclick="changeBet(false)">‚àí</button>
                    <input type="number" id="bet-val-bal" step="0.05" readonly>
                    <button onclick="changeBet(true)">+</button>
                </div>

                <div class="sys-row" style="margin-top: 15px;">
                    <button class="sys-btn" id="ball-cashout-btn" onclick="cashoutBalloon()" style="display:none; background: var(--blue); border-color: var(--blue);">–í–´–í–ï–°–¢–ò</button>
                    <button class="main-action-btn" id="ball-main-btn" onclick="handleBalloonAction()">–ò–ì–†–ê–¢–¨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="deposit-modal" class="modal-overlay">
        <div class="modal">
            <h2 style="margin: 0 0 10px;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h2>
            <p style="font-size: 13px; color: #888;">–ú–∏–Ω–∏–º—É–º 0.1 USDT</p>
            <input type="number" id="dep-amount" value="1.0" step="0.1" min="0.1">
            <button class="modal-btn" id="pay-crypto-btn" style="background: #2b6bf3; color: #fff;">–û–ü–õ–ê–¢–ò–¢–¨</button>
            <button class="modal-btn close-modal" style="background: #222; color: #fff;">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="auto-modal" class="modal-overlay">
        <div class="modal">
            <h2 style="margin: 0 0 10px;">–ê–≤—Ç–æ-–∏–≥—Ä–∞</h2>
            <input type="number" id="auto-rounds" value="10">
            <button class="modal-btn" id="auto-start" style="background: #fff; color: #000;">–ó–ê–ü–£–°–¢–ò–¢–¨</button>
            <button class="modal-btn close-modal" style="background: #222; color: #fff;">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ô –°–¢–ï–ô–¢ ---
        let st = {
            isDemo: true, demoBal: 1000, realBal: 0.00,
            betDemo: 1, betReal: 0.05, currentBet: 1,
            activeGame: null
        };

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
        if (tg.initDataUnsafe?.user) {
            const u = tg.initDataUnsafe.user;
            document.getElementById('user-name').innerText = u.first_name;
            document.getElementById('profile-name-large').innerText = u.first_name;
            if (u.photo_url) { document.getElementById('user-photo').src = u.photo_url; document.getElementById('profile-img-large').src = u.photo_url; }
        }

        // --- –ë–ê–õ–ê–ù–° –ò UI ---
        function updateBal() {
            const m = document.getElementById('balance-mode'); const v = document.getElementById('balance-value');
            if (st.isDemo) {
                m.innerText = "–î–µ–º–æ –°—á–µ—Ç"; v.innerText = st.demoBal.toFixed(0) + " üç¨"; v.style.color = "var(--demo)";
            } else {
                m.innerText = "USDT –ë–∞–ª–∞–Ω—Å"; v.innerText = st.realBal.toFixed(2) + " USDT"; v.style.color = "var(--accent)";
            }
            document.getElementById('prof-real-bal').innerText = st.realBal.toFixed(2);
            document.getElementById('prof-demo-bal').innerText = st.demoBal.toFixed(0);
            document.getElementById('bet-val').value = st.isDemo ? st.currentBet.toFixed(0) : st.currentBet.toFixed(2);
            document.getElementById('bet-val-bal').value = document.getElementById('bet-val').value;
        }

        function switchBalance() {
            if (diceSt.rolling || ballSt.playing) return;
            st.isDemo = !st.isDemo;
            st.currentBet = st.isDemo ? st.betDemo : st.betReal;
            updateBal(); tg.HapticFeedback.selectionChanged();
        }

        function changeBet(isUp) {
            if (diceSt.rolling || ballSt.playing) return;
            const step = st.isDemo ? st.betDemo : st.betReal;
            const min = st.isDemo ? 1 : 0.05;
            if (isUp) st.currentBet += step; else st.currentBet = Math.max(min, st.currentBet - step);
            st.currentBet = parseFloat(st.currentBet.toFixed(2)); 
            updateBal(); tg.HapticFeedback.selectionChanged();
        }

        document.getElementById('balance-container').onclick = switchBalance;

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function openGame(game) {
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('btn-back').style.display = 'flex';
            if (game === 'dice') {
                document.getElementById('game-screen').style.display = 'flex';
                st.activeGame = 'dice';
                if(!scene) init3D();
            } else if (game === 'balloon') {
                document.getElementById('balloon-screen').style.display = 'flex';
                st.activeGame = 'balloon';
            }
        }

        document.getElementById('btn-back').onclick = () => {
            if(diceSt.rolling || ballSt.playing) return;
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('menu-screen').style.display = 'flex';
            document.getElementById('btn-back').style.display = 'none';
            st.activeGame = null;
        };

        document.getElementById('btn-profile').onclick = () => {
            if(diceSt.rolling || ballSt.playing) return;
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('profile-screen').style.display = 'flex';
            document.getElementById('btn-back').style.display = 'flex';
        };

        // --- –ò–°–¢–û–†–ò–Ø –ò–ì–† ---
        let dHist = [], bHist = [];
        function addHist(game, win) {
            const arr = game === 'dice' ? dHist : bHist;
            const elId = game === 'dice' ? 'dice-history' : 'balloon-history';
            arr.push(win ? 'üü©' : 'üü•');
            if(arr.length > 10) arr.shift();
            document.getElementById(elId).innerText = arr.join(' ');
        }

        // ==========================================
        //               –ò–ì–†–ê: –ö–£–ë–ò–ö
        // ==========================================
        let diceSt = { cond: 'even', mult: 1.9, fast: false, auto: false, autoCount: 0, rolling: false };
        
        const dRules = {
            'even': { m: 1.9, check: r => r%2===0 }, 'odd': { m: 1.9, check: r => r%2!==0 },
            'gt3': { m: 1.9, check: r => r>3 }, 'lt4': { m: 1.9, check: r => r<4 },
            'sec1': { m: 2.8, check: r => r===1||r===2 }, 'sec2': { m: 2.8, check: r => r===3||r===4 }, 'sec3': { m: 2.8, check: r => r===5||r===6 },
            'num1': { m: 4.5, check: r => r===1 }, 'num2': { m: 4.5, check: r => r===2 }, 'num3': { m: 4.5, check: r => r===3 },
            'num4': { m: 4.5, check: r => r===4 }, 'num5': { m: 4.5, check: r => r===5 }, 'num6': { m: 4.5, check: r => r===6 },
        };

        document.querySelectorAll('#game-screen .choice-btn').forEach(btn => {
            btn.onclick = (e) => {
                document.querySelectorAll('#game-screen .choice-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                diceSt.cond = e.target.dataset.cond; diceSt.mult = dRules[diceSt.cond].m;
                tg.HapticFeedback.selectionChanged();
            };
        });

        document.getElementById('fast-toggle').onclick = (e) => { diceSt.fast = !diceSt.fast; e.target.classList.toggle('active'); tg.HapticFeedback.impactOccurred('light'); };

        let scene, camera, renderer, dice;
        const rots = { 1:{x:0,y:-Math.PI/2,z:0}, 6:{x:0,y:Math.PI/2,z:0}, 2:{x:Math.PI/2,y:0,z:0}, 5:{x:-Math.PI/2,y:0,z:0}, 3:{x:0,y:0,z:0}, 4:{x:0,y:Math.PI,z:0} };

        function init3D() {
            scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 100); camera.position.z = 8;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('three-container').appendChild(renderer.domElement);
            scene.add(new THREE.DirectionalLight(0xffffff, 1.3), new THREE.AmbientLight(0xffffff, 0.7));

            const makeFace = (n) => {
                const cv = document.createElement('canvas'); cv.width = 256; cv.height = 256; const ctx = cv.getContext('2d');
                ctx.fillStyle = '#181818'; ctx.beginPath(); ctx.roundRect(0,0,256,256,50); ctx.fill(); ctx.fillStyle = '#fff';
                const p = { 1:[[128,128]], 2:[[70,70],[186,186]], 3:[[70,70],[128,128],[186,186]], 4:[[70,70],[186,70],[70,186],[186,186]], 5:[[70,70],[186,70],[128,128],[70,186],[186,186]], 6:[[70,70],[186,70],[70,128],[186,128],[70,186],[186,186]] };
                p[n].forEach(c => { ctx.beginPath(); ctx.arc(c[0],c[1],22,0,7); ctx.fill(); });
                return new THREE.MeshStandardMaterial({ map: new THREE.CanvasTexture(cv), roughness: 0.2 });
            };
            dice = new THREE.Mesh(new THREE.BoxGeometry(1.6,1.6,1.6), [makeFace(1), makeFace(6), makeFace(2), makeFace(5), makeFace(3), makeFace(4)]);
            dice.rotation.x = 0.2; scene.add(dice);
            const anim = () => { requestAnimationFrame(anim); renderer.render(scene, camera); }; anim();
        }

        function btnRollClick() {
            if (diceSt.auto) { diceSt.auto = false; updateDiceBtns(); return; }
            if (diceSt.rolling) return;
            rollDice();
        }

        function updateDiceBtns() {
            const txt = diceSt.auto ? "–°–¢–û–ü (–ê–í–¢–û)" : "–ë–†–û–°–ò–¢–¨ –ö–£–ë–ò–ö";
            const bg = diceSt.auto ? "var(--danger)" : "var(--accent)";
            const c = diceSt.auto ? "#fff" : "#000";
            const m = document.getElementById('dice-main-btn'), mini = document.getElementById('dice-mini-btn');
            m.innerText = txt; m.style.background = bg; m.style.color = c;
            mini.innerText = diceSt.auto ? "–°–¢–û–ü" : "–ò–ì–†–ê–¢–¨"; mini.style.background = bg; mini.style.color = c;
        }

        function rollDice() {
            if (st.isDemo) { st.demoBal = Math.max(100, st.demoBal - st.currentBet); } 
            else { if(st.realBal < st.currentBet) { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞!"); diceSt.auto = false; updateDiceBtns(); return; } st.realBal -= st.currentBet; }
            updateBal();

            diceSt.rolling = true;
            document.getElementById('dice-lock-zone').classList.add('locked');
            document.getElementById('result-display').classList.remove('show');

            const res = Math.floor(Math.random() * 6) + 1;
            const target = rots[res]; const sRot = { x: dice.rotation.x, y: dice.rotation.y, z: dice.rotation.z };
            const spins = diceSt.fast ? 2 : 6, dur = diceSt.fast ? 500 : 1600, startT = Date.now();

            const anim = () => {
                const t = Math.min((Date.now() - startT) / dur, 1); const ease = 1 - Math.pow(1 - t, 3);
                dice.rotation.x = sRot.x + (target.x + spins*Math.PI*2 - sRot.x) * ease;
                dice.rotation.y = sRot.y + (target.y + spins*Math.PI*2 - sRot.y) * ease;
                dice.rotation.z = sRot.z + (target.z + spins*Math.PI*2 - sRot.z) * ease;
                if (t < 1) requestAnimationFrame(anim); else finishDice(res);
            }; requestAnimationFrame(anim); tg.HapticFeedback.impactOccurred('medium');
        }

        function finishDice(res) {
            dice.rotation.set(rots[res].x, rots[res].y, rots[res].z);
            const isWin = dRules[diceSt.cond].check(res);
            const rTxt = document.getElementById('result-text');
            
            addHist('dice', isWin);

            if (isWin) {
                const pz = st.currentBet * diceSt.mult;
                if(st.isDemo) st.demoBal += pz; else st.realBal += pz;
                rTxt.innerText = `+${pz.toFixed(st.isDemo?0:2)}`; rTxt.style.color = "var(--accent)";
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                rTxt.innerText = `‚àí${st.isDemo ? st.currentBet.toFixed(0) : st.currentBet.toFixed(2)}`; rTxt.style.color = "var(--danger)";
                tg.HapticFeedback.notificationOccurred('error');
            }
            
            document.getElementById('result-display').classList.add('show'); updateBal();

            setTimeout(() => {
                diceSt.rolling = false;
                if (diceSt.auto) { diceSt.autoCount--; if(diceSt.autoCount>0) rollDice(); else { diceSt.auto = false; updateDiceBtns(); document.getElementById('dice-lock-zone').classList.remove('locked'); } }
                else { document.getElementById('dice-lock-zone').classList.remove('locked'); }
            }, diceSt.fast ? 500 : 1200);
        }

        // –ê–≤—Ç–æ-–∏–≥—Ä–∞ –∫—É–±–∏–∫
        document.getElementById('auto-open').onclick = () => document.getElementById('auto-modal').style.display = 'flex';
        document.getElementById('auto-start').onclick = () => {
            diceSt.autoCount = parseInt(document.getElementById('auto-rounds').value) || 5; diceSt.auto = true;
            document.getElementById('auto-modal').style.display = 'none'; updateDiceBtns(); rollDice();
        };


        // ==========================================
        //               –ò–ì–†–ê: –®–ê–†–ò–ö
        // ==========================================
        let ballSt = { playing: false, pumping: false, risk: 'low', mult: 1.0, popChance: 0.05, pumps: 0 };
        const bParams = { 
            'low': { step: 1.2, basePop: 0.03, popStep: 0.03 }, 
            'med': { step: 1.5, basePop: 0.10, popStep: 0.06 }, 
            'high':{ step: 2.0, basePop: 0.20, popStep: 0.12 } 
        };

        document.querySelectorAll('.risk-btn').forEach(btn => {
            btn.onclick = (e) => {
                if(ballSt.playing) return;
                document.querySelectorAll('.risk-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                ballSt.risk = e.target.dataset.risk;
                tg.HapticFeedback.selectionChanged();
            };
        });

        function handleBalloonAction() {
            if(ballSt.pumping) return;
            if(!ballSt.playing) {
                // –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã (–ü–µ—Ä–≤—ã–π –Ω–∞–¥—É–≤)
                if (st.isDemo) { st.demoBal = Math.max(100, st.demoBal - st.currentBet); } 
                else { if(st.realBal < st.currentBet) { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!"); return; } st.realBal -= st.currentBet; }
                updateBal();
                
                ballSt.playing = true; ballSt.mult = 1.0; ballSt.pumps = 0;
                const prm = bParams[ballSt.risk]; ballSt.popChance = prm.basePop;
                
                document.getElementById('the-balloon').innerText = 'üéà';
                document.getElementById('the-balloon').style.transform = 'scale(1)';
                document.getElementById('balloon-mult').innerText = '1.00x';
                document.getElementById('balloon-mult').style.color = '#fff';
                
                document.getElementById('ball-main-btn').innerText = '–ù–ê–î–£–¢–¨ –ü–£–ó–´–†–¨';
                document.getElementById('ball-mini-btn').innerText = '–ù–ê–î–£–¢–¨';
                document.getElementById('ball-cashout-btn').style.display = 'block';
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–º–µ–Ω—É —Å—Ç–∞–≤–∫–∏ –∏ —Ä–∏—Å–∫–∞
                Array.from(document.getElementById('balloon-lock-zone').children).forEach(el => {
                    if(!el.classList.contains('sys-row')) el.classList.add('locked');
                });
                
                pumpBalloon();
            } else {
                // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –Ω–∞–¥—É–≤–∞
                pumpBalloon();
            }
        }

        function pumpBalloon() {
            ballSt.pumping = true;
            document.getElementById('ball-main-btn').classList.add('locked');
            document.getElementById('ball-cashout-btn').classList.add('locked');
            
            tg.HapticFeedback.impactOccurred('heavy');
            
            setTimeout(() => {
                const rng = Math.random();
                if (rng < ballSt.popChance) {
                    // –õ–æ–ø–Ω—É–ª
                    document.getElementById('the-balloon').innerText = 'üí•';
                    document.getElementById('balloon-mult').innerText = '–õ–û–ü–ù–£–õ!';
                    document.getElementById('balloon-mult').style.color = 'var(--danger)';
                    addHist('balloon', false);
                    tg.HapticFeedback.notificationOccurred('error');
                    resetBalloonUI();
                } else {
                    // –£—Å–ø–µ—à–Ω—ã–π –Ω–∞–¥—É–≤
                    ballSt.pumps++;
                    const prm = bParams[ballSt.risk];
                    ballSt.mult *= prm.step;
                    ballSt.popChance += prm.popStep;
                    
                    document.getElementById('balloon-mult').innerText = ballSt.mult.toFixed(2) + 'x';
                    document.getElementById('the-balloon').style.transform = `scale(${1 + ballSt.pumps * 0.3})`;
                    tg.HapticFeedback.notificationOccurred('success');
                    
                    ballSt.pumping = false;
                    document.getElementById('ball-main-btn').classList.remove('locked');
                    document.getElementById('ball-cashout-btn').classList.remove('locked');
                }
            }, 400);
        }

        function cashoutBalloon() {
            if(!ballSt.playing || ballSt.pumping) return;
            const win = st.currentBet * ballSt.mult;
            if(st.isDemo) st.demoBal += win; else st.realBal += win;
            
            document.getElementById('balloon-mult').innerText = `+${win.toFixed(2)}`;
            document.getElementById('balloon-mult').style.color = 'var(--accent)';
            addHist('balloon', true);
            tg.HapticFeedback.notificationOccurred('success');
            updateBal();
            resetBalloonUI();
        }

        function resetBalloonUI() {
            ballSt.playing = false; ballSt.pumping = false;
            setTimeout(() => {
                document.getElementById('the-balloon').style.transform = 'scale(1)';
                document.getElementById('ball-main-btn').innerText = '–ò–ì–†–ê–¢–¨';
                document.getElementById('ball-mini-btn').innerText = '–ò–ì–†–ê–¢–¨';
                document.getElementById('ball-cashout-btn').style.display = 'none';
                document.getElementById('ball-main-btn').classList.remove('locked');
                Array.from(document.getElementById('balloon-lock-zone').children).forEach(el => el.classList.remove('locked'));
            }, 1500);
        }

        // --- –ú–û–î–ê–õ–ö–ò (–ó–∞–∫—Ä—ã—Ç–∏–µ –∏ –î–µ–ø–æ–∑–∏—Ç) ---
        document.querySelectorAll('.close-modal').forEach(b => b.onclick = e => e.target.closest('.modal-overlay').style.display = 'none');
        const openDep = () => document.getElementById('deposit-modal').style.display = 'flex';
        document.getElementById('btn-deposit').onclick = openDep; document.getElementById('prof-deposit-btn').onclick = openDep;
        
        document.getElementById('pay-crypto-btn').onclick = () => {
            const amt = parseFloat(document.getElementById('dep-amount').value);
            if (amt < 0.1) return alert("–ú–∏–Ω–∏–º—É–º 0.1 USDT!");
            document.getElementById('deposit-modal').style.display = 'none';
            tg.sendData(JSON.stringify({ action: "deposit", amount: amt })); 
            tg.close();
        };

        updateBal();
    </script>
</body>
</html>
