<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #1c1c1d;
            --card-bg: #2c2c2e;
            --accent-color: #0088cc;
            --accent-hover: #0077b3;
            --text-main: #ffffff;
            --text-secondary: #aaaaaa;
            --win-color: #4cd964;
            --loss-color: #ff3b30;
        }

        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        button { font-family: inherit; cursor: pointer; }

        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; position: relative; z-index: 100; }
        .mode-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; transition: 0.3s; }
        .profile-trigger { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        
        /* –ê–≤–∞—Ç–∞—Ä */
        .avatar-container { position: relative; width: 38px; height: 38px; z-index: 101; transition: all 0.5s ease; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); display: none; }
        .avatar-fallback { 
            width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #0088cc, #004466); 
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; border: 2px solid rgba(255,255,255,0.1);
        }

        /* --- SCREENS --- */
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; height: calc(100vh - 70px); position: absolute; top: 70px; left: 0; }
        .screen.active { display: flex; }

        /* --- PROFILE SCREEN --- */
        #profile-screen { justify-content: center; top: 0; height: 100vh; z-index: 90; opacity: 0; pointer-events: none; display: flex; transition: opacity 0.4s ease; }
        .profile-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(25px) brightness(0.3); transform: scale(1.2); }
        .profile-content { position: relative; text-align: center; z-index: 92; width: 100%; }
        .user-nick { color: var(--accent-color); font-size: 16px; margin-bottom: 5px; display: block; }
        .user-name { font-size: 28px; font-weight: 800; margin-bottom: 25px; }
        .balance-card { background: rgba(255,255,255,0.08); padding: 20px; border-radius: 20px; backdrop-filter: blur(15px); margin: 10px 40px; border: 1px solid rgba(255,255,255,0.1); }

        /* --- MENU SCREEN --- */
        #menu-screen { padding: 20px; display: block; top: 70px; }
        .game-card { background: var(--card-bg); border-radius: 24px; padding: 20px; display: flex; align-items: center; gap: 18px; box-shadow: 0 10px 20px rgba(0,0,0,0.4); margin-bottom: 15px;}
        .game-preview { width: 70px; height: 70px; border-radius: 18px; font-size: 35px; background: linear-gradient(135deg, #0088cc, #005588); display: flex; align-items: center; justify-content: center; }

        /* --- GAME SCREEN --- */
        .top-notify { background: rgba(0, 136, 204, 0.2); border: 1px solid var(--accent-color); padding: 8px 15px; border-radius: 15px; font-size: 14px; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        
        .jump-box { position: relative; transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1); margin-top: 40px; }
        .scene { width: 100px; height: 100px; perspective: 1000px; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.15, 0.8, 0.4, 1); transform: rotateX(-20deg) rotateY(20deg); }
        .cube__face { position: absolute; width: 100px; height: 100px; border: 2px solid rgba(255,255,255,0.3); line-height: 100px; font-size: 40px; font-weight: bold; text-align: center; background: rgba(255,255,255,0.1); border-radius: 20px; display: flex; align-items: center; justify-content: center; transition: background 0.4s, color 0.4s, box-shadow 0.4s, border-color 0.4s; }
        .cube__face.winner { background: #fff !important; color: #000 !important; box-shadow: 0 0 40px #fff; }
        .cube__face.loser { background: #ff3b30 !important; color: #fff !important; box-shadow: 0 0 20px #ff3b30; border-color: #ff3b30; }
        .cube__face--1 { transform: rotateY(0deg) translateZ(50px); }
        .cube__face--2 { transform: rotateY(180deg) translateZ(50px); }
        .cube__face--3 { transform: rotateY(90deg) translateZ(50px); }
        .cube__face--4 { transform: rotateY(-90deg) translateZ(50px); }
        .cube__face--5 { transform: rotateX(90deg) translateZ(50px); }
        .cube__face--6 { transform: rotateX(-90deg) translateZ(50px); }
        .shadow { position: absolute; bottom: -30px; left: 10px; width: 80px; height: 10px; background: rgba(0,0,0,0.6); border-radius: 50%; filter: blur(5px); transition: 1.5s; }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–°—Ç–∞–≤–∫–∏) */
        .controls-panel { width: 90%; background: var(--card-bg); border-radius: 20px; padding: 15px; margin-top: auto; margin-bottom: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 15px; }
        
        .controls-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        
        .btn-icon { background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 12px; width: 45px; height: 45px; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        
        .bet-input-wrap { flex: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); border-radius: 12px; height: 45px; }
        .bet-input { background: transparent; border: none; color: white; font-size: 20px; font-weight: bold; text-align: center; width: 100%; outline: none; }
        
        .step-toggles { display: flex; justify-content: center; gap: 10px; }
        .step-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--text-secondary); padding: 5px 15px; border-radius: 10px; font-size: 14px; transition: 0.2s; }
        .step-btn.active { background: rgba(255,255,255,0.1); color: white; border-color: white; }

        .play-btn { background: var(--accent-color); color: white; border: none; border-radius: 15px; padding: 15px; font-size: 18px; font-weight: bold; width: 100%; transition: 0.2s; }
        .play-btn:active { transform: scale(0.98); }
        .play-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .play-btn.auto-stop { background: var(--loss-color); }

        .condition-select { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px 15px; border-radius: 12px; font-size: 14px; font-weight: bold; flex: 1; display: flex; justify-content: center; align-items: center; gap: 5px; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: flex-end; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content { background: var(--card-bg); width: 100%; border-radius: 25px 25px 0 0; padding: 25px 20px; box-sizing: border-box; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .modal-option { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; transition: 0.2s; border: 1px solid transparent; }
        .modal-option.selected { border-color: var(--accent-color); background: rgba(0, 136, 204, 0.1); }
        .modal-input-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .modal-input { flex: 1; background: rgba(0,0,0,0.3); border: none; color: white; padding: 10px; border-radius: 10px; text-align: center; font-size: 16px; outline: none; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è */
        body.profile-open .avatar-container { transform: scale(4) translateY(45px); }
        body.profile-open #header-balance, body.profile-open #mode-toggle { opacity: 0; pointer-events: none; }
        .back-btn { display: none; }
        body.profile-open .back-btn, body.game-open .back-btn { display: block; }
        body.profile-open #profile-screen { opacity: 1; pointer-events: all; }
        body.profile-open #menu-screen, body.profile-open #game-screen { display: none !important; }

    </style>
</head>
<body id="body">

    <header>
        <button class="mode-btn" id="mode-toggle" onclick="toggleMode()">–î–µ–º–æ</button>
        <div class="profile-trigger" onclick="toggleProfile()">
            <span id="header-balance">1000 üç¨</span>
            <div class="avatar-container" id="avatar-container">
                <img src="" alt="" id="user-photo" class="avatar">
                <div id="user-fallback" class="avatar-fallback">?</div>
            </div>
            <button class="mode-btn back-btn">–ù–∞–∑–∞–¥</button>
        </div>
    </header>

    <div id="menu-screen" class="screen active">
        <div class="game-card">
            <div class="game-preview">üé≤</div>
            <div class="game-info" style="flex: 1;">
                <div style="font-size: 20px; font-weight: 700;">–ö—É–±–∏–∫</div>
                <div style="color: var(--text-secondary); font-size: 13px;">–£–≥–∞–¥–∞–π –ß—ë—Ç / –ù–µ—á–µ—Ç</div>
            </div>
            <button class="mode-btn" style="background: var(--accent-color);" onclick="openGame()">–ò–≥—Ä–∞—Ç—å</button>
        </div>
    </div>

    <div id="profile-screen">
        <div class="profile-bg" id="profile-blur-bg"></div>
        <div class="profile-content">
            <span class="user-nick" id="user-nick">@username</span>
            <div class="user-name" id="user-full-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="balance-card">
                <div style="color: var(--text-secondary); font-size: 12px;">–î–ï–ú–û –ë–ê–õ–ê–ù–°</div>
                <div id="demo-val" style="font-size: 24px; font-weight: 800;">1000 üç¨</div>
            </div>
            <div class="balance-card">
                <div style="color: var(--text-secondary); font-size: 12px;">–†–ï–ê–õ–¨–ù–´–ô –°–ß–ï–¢</div>
                <div id="real-val" style="font-size: 24px; font-weight: 800;">0.00 $</div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="top-notify" id="win-notify">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: 19 üç¨</div>
        
        <div class="jump-box" id="jump-box">
            <div class="shadow" id="shadow"></div>
            <div class="scene">
                <div class="cube" id="cube">
                    <div class="cube__face cube__face--1">1</div>
                    <div class="cube__face cube__face--2">2</div>
                    <div class="cube__face cube__face--3">3</div>
                    <div class="cube__face cube__face--4">4</div>
                    <div class="cube__face cube__face--5">5</div>
                    <div class="cube__face cube__face--6">6</div>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="controls-row">
                <button class="btn-icon" onclick="openMenuModal()">‚ò∞</button>
                <button class="condition-select" onclick="openConditionModal()">
                    <span id="current-condition-text">–ß—ë—Ç (1.9x)</span> ‚ñº
                </button>
            </div>

            <div class="controls-row">
                <button class="btn-icon" onclick="changeBet(-1)">-</button>
                <div class="bet-input-wrap">
                    <input type="number" id="bet-input" class="bet-input" value="10" onchange="manualBetChange()">
                </div>
                <button class="btn-icon" onclick="changeBet(1)">+</button>
            </div>
            
            <div class="step-toggles">
                <button class="step-btn active" id="step-5" onclick="setStep(5)">¬± 5</button>
                <button class="step-btn" id="step-10" onclick="setStep(10)">¬± 10</button>
            </div>

            <button id="roll-button" class="play-btn" onclick="handleRollClick()">–ë–†–û–°–ò–¢–¨ üé≤</button>
        </div>
    </div>

    <div class="modal-overlay" id="condition-modal" onclick="closeModals(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">–£—Å–ª–æ–≤–∏–µ –ø–æ–±–µ–¥—ã</div>
            <div class="modal-option selected" id="cond-even" onclick="selectCondition('even')">
                <span>–ß—ë—Ç–Ω—ã–µ (2, 4, 6)</span>
                <span style="color: var(--win-color);">1.9x</span>
            </div>
            <div class="modal-option" id="cond-odd" onclick="selectCondition('odd')">
                <span>–ù–µ—á–µ—Ç–Ω—ã–µ (1, 3, 5)</span>
                <span style="color: var(--win-color);">1.9x</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="menu-modal" onclick="closeModals(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ê–≤—Ç–æ–∏–≥—Ä—ã</div>
            
            <div class="modal-option" id="auto-inf" onclick="selectAutoMode('infinite')">
                <span>–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –∞–≤—Ç–æ–∏–≥—Ä–∞</span>
                <span id="check-inf" style="display:none;">‚úÖ</span>
            </div>
            
            <div class="modal-option" style="flex-direction: column; align-items: stretch;" id="auto-limit" onclick="selectAutoMode('limit')">
                <div style="display: flex; justify-content: space-between;">
                    <span>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –ø—Ä–æ—Ñ–∏—Ç–µ/–ª—É–∑–µ</span>
                    <span id="check-limit" style="display:none;">‚úÖ</span>
                </div>
                <div class="modal-input-row" onclick="event.stopPropagation()">
                    <select id="limit-type" class="modal-input" style="flex: 0.5;">
                        <option value="profit">–ü–ª—é—Å</option>
                        <option value="loss">–ú–∏–Ω—É—Å</option>
                    </select>
                    <input type="number" id="limit-amount" class="modal-input" value="50" placeholder="–°—É–º–º–∞">
                </div>
            </div>

            <button class="play-btn" style="margin-top: 15px;" onclick="startAutoPlay()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–∏–≥—Ä—É</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        let state = {
            mode: 'demo', // 'demo' –∏–ª–∏ 'real'
            demoBalance: 1000,
            realBalance: 0,
            
            isProfileOpen: false,
            isGameOpen: false,
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—É–±–∏–∫–∞
            currentRotationX: -20,
            currentRotationY: 20,
            isRolling: false,
            
            // –°—Ç–∞–≤–∫–∏
            betAmount: 10,
            betStep: 5,
            winCondition: 'even', // 'even' –∏–ª–∏ 'odd'
            multiplier: 1.9,
            
            // –ê–≤—Ç–æ–∏–≥—Ä–∞
            autoMode: 'none', // 'none', 'infinite', 'limit'
            autoActive: false,
            startBalance: 0,
            autoTimeout: null
        };

        // --- –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–£–õ–£–ß–®–ï–ù–ù–û–ï) ---
        function setupUser() {
            const user = tg.initDataUnsafe?.user;
            
            const nameElem = document.getElementById('user-full-name');
            const nickElem = document.getElementById('user-nick');
            const photoImg = document.getElementById('user-photo');
            const photoFallback = document.getElementById('user-fallback');
            const blurElem = document.getElementById('profile-blur-bg');

            if (user) {
                const firstName = user.first_name || "–ò–≥—Ä–æ–∫";
                const lastName = user.last_name || "";
                nameElem.innerText = `${firstName} ${lastName}`.trim();
                nickElem.innerText = user.username ? `@${user.username}` : '';
                
                if (user.photo_url) {
                    photoImg.src = user.photo_url;
                    photoImg.style.display = 'block';
                    photoFallback.style.display = 'none';
                    blurElem.style.backgroundImage = `url(${user.photo_url})`;
                } else {
                    // –ù–ê–î–ï–ñ–ù–´–ô –õ–û–ö–ê–õ–¨–ù–´–ô –§–û–õ–õ–ë–≠–ö
                    photoImg.style.display = 'none';
                    photoFallback.style.display = 'flex';
                    photoFallback.innerText = firstName.charAt(0).toUpperCase();
                    blurElem.style.backgroundColor = '#004466'; // –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π —Ñ–æ–Ω –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ
                }
            } else {
                nameElem.innerText = "–ò–≥—Ä–æ–∫ (–í–Ω–µ –¢–ì)";
                nickElem.innerText = "@test_mode";
                photoImg.style.display = 'none';
                photoFallback.style.display = 'flex';
                photoFallback.innerText = "T";
            }
            updateUI();
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø –ò –ë–ê–õ–ê–ù–° ---
        function toggleMode() {
            if(state.isRolling || state.autoActive) return; // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
            state.mode = state.mode === 'demo' ? 'real' : 'demo';
            document.getElementById('mode-toggle').innerText = state.mode === 'demo' ? '–î–µ–º–æ' : '–ë–∞–ª–∞–Ω—Å';
            tg.HapticFeedback.selectionChanged();
            updateUI();
        }

        function toggleProfile() {
            if(state.isRolling || state.autoActive) return;
            if (state.isGameOpen) return closeGame();
            
            state.isProfileOpen = !state.isProfileOpen;
            document.body.classList.toggle('profile-open', state.isProfileOpen);
            tg.HapticFeedback.impactOccurred('light');
        }

        function openGame() {
            state.isGameOpen = true;
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            document.body.classList.add('game-open');
            updateUI();
        }

        function closeGame() {
            if(state.autoActive) stopAutoPlay();
            state.isGameOpen = false;
            document.getElementById('menu-screen').classList.add('active');
            document.getElementById('game-screen').classList.remove('active');
            document.body.classList.remove('game-open');
        }

        // --- –õ–û–ì–ò–ö–ê –°–¢–ê–í–û–ö ---
        function getBalance() { return state.mode === 'demo' ? state.demoBalance : state.realBalance; }
        function setBalance(val) { 
            if(state.mode === 'demo') state.demoBalance = val; 
            else state.realBalance = val; 
            updateUI();
        }

        function updateUI() {
            const bal = getBalance();
            const curr = state.mode === 'demo' ? 'üç¨' : '$';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–ø–∫—É –∏ –ø—Ä–æ—Ñ–∏–ª—å
            document.getElementById('header-balance').innerText = `${bal.toFixed(0)} ${curr}`;
            document.getElementById('demo-val').innerText = `${state.demoBalance.toFixed(0)} üç¨`;
            document.getElementById('real-val').innerText = `${state.realBalance.toFixed(2)} $`;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–ø—É—Ç —Å—Ç–∞–≤–∫–∏
            document.getElementById('bet-input').value = state.betAmount;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–∏–≥—Ä—ã—à–µ
            const winAmt = (state.betAmount * state.multiplier).toFixed(1);
            document.getElementById('win-notify').innerText = `–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: ${winAmt} ${curr}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
            const rollBtn = document.getElementById('roll-button');
            if(state.autoActive) {
                rollBtn.innerText = "–û–°–¢–ê–ù–û–í–ò–¢–¨ –ê–í–¢–û–ò–ì–†–£";
                rollBtn.classList.add('auto-stop');
            } else {
                rollBtn.innerText = "–ë–†–û–°–ò–¢–¨ üé≤";
                rollBtn.classList.remove('auto-stop');
            }
        }

        function setStep(val) {
            state.betStep = val;
            document.getElementById('step-5').classList.toggle('active', val === 5);
            document.getElementById('step-10').classList.toggle('active', val === 10);
            tg.HapticFeedback.selectionChanged();
        }

        function changeBet(direction) {
            if(state.isRolling || state.autoActive) return;
            let newBet = state.betAmount + (state.betStep * direction);
            if(newBet < 1) newBet = 1;
            if(newBet > getBalance()) newBet = getBalance();
            state.betAmount = newBet;
            tg.HapticFeedback.impactOccurred('light');
            updateUI();
        }

        function manualBetChange() {
            if(state.isRolling || state.autoActive) return;
            let val = parseInt(document.getElementById('bet-input').value) || 1;
            if(val < 1) val = 1;
            if(val > getBalance()) val = getBalance();
            state.betAmount = val;
            updateUI();
        }

        // --- –ú–û–î–ê–õ–ö–ò ---
        function openConditionModal() { document.getElementById('condition-modal').classList.add('active'); }
        function openMenuModal() { document.getElementById('menu-modal').classList.add('active'); }
        function closeModals(e) { if(e.target.classList.contains('modal-overlay')) e.target.classList.remove('active'); }

        function selectCondition(cond) {
            state.winCondition = cond;
            document.getElementById('cond-even').classList.toggle('selected', cond === 'even');
            document.getElementById('cond-odd').classList.toggle('selected', cond === 'odd');
            document.getElementById('current-condition-text').innerText = cond === 'even' ? '–ß—ë—Ç (1.9x)' : '–ù–µ—á–µ—Ç (1.9x)';
            document.getElementById('condition-modal').classList.remove('active');
            tg.HapticFeedback.selectionChanged();
        }

        function selectAutoMode(mode) {
            state.autoMode = mode;
            document.getElementById('auto-inf').classList.toggle('selected', mode === 'infinite');
            document.getElementById('auto-limit').classList.toggle('selected', mode === 'limit');
            document.getElementById('check-inf').style.display = mode === 'infinite' ? 'block' : 'none';
            document.getElementById('check-limit').style.display = mode === 'limit' ? 'block' : 'none';
        }

        // --- –ò–ì–†–ê –ò –ê–í–¢–û–ò–ì–†–ê ---
        function handleRollClick() {
            if(state.autoActive) {
                stopAutoPlay();
            } else {
                executeRoll();
            }
        }

        function startAutoPlay() {
            if(state.autoMode === 'none') return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∞–≤—Ç–æ–∏–≥—Ä—ã!');
            if(getBalance() < state.betAmount) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');
            
            state.autoActive = true;
            state.startBalance = getBalance();
            document.getElementById('menu-modal').classList.remove('active');
            updateUI();
            executeRoll();
        }

        function stopAutoPlay() {
            state.autoActive = false;
            clearTimeout(state.autoTimeout);
            updateUI();
        }

        function executeRoll() {
            if(state.isRolling || getBalance() < state.betAmount) {
                if(state.autoActive) stopAutoPlay();
                return;
            }

            state.isRolling = true;
            document.getElementById('roll-button').disabled = true;
            
            // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
            setBalance(getBalance() - state.betAmount);
            
            // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –∫—É–±–∞
            document.querySelectorAll('.cube__face').forEach(f => {
                f.classList.remove('winner', 'loser');
            });

            const result = Math.floor(Math.random() * 6) + 1;
            const rots = { 1:{x:0,y:0}, 2:{x:0,y:180}, 3:{x:0,y:-90}, 4:{x:0,y:90}, 5:{x:-90,y:0}, 6:{x:90,y:0} };

            state.currentRotationX += 1440 + (rots[result].x - (state.currentRotationX % 360));
            state.currentRotationY += 1440 + (rots[result].y - (state.currentRotationY % 360));

            const jBox = document.getElementById('jump-box');
            jBox.style.transform = 'translateY(-180px) scale(1.1)';
            document.getElementById('shadow').style.transform = 'scale(0.3)';
            document.getElementById('cube').style.transform = `rotateX(${state.currentRotationX}deg) rotateY(${state.currentRotationY}deg)`;

            setTimeout(() => {
                jBox.style.transform = 'translateY(0) scale(1)';
                document.getElementById('shadow').style.transform = 'scale(1)';
            }, 750);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            setTimeout(() => {
                state.isRolling = false;
                document.getElementById('roll-button').disabled = false;
                
                const targetFace = document.querySelector(`.cube__face--${result}`);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–±–µ–¥—É
                const isEven = result % 2 === 0;
                const isWin = (isEven && state.winCondition === 'even') || (!isEven && state.winCondition === 'odd');

                if(isWin) {
                    targetFace.classList.add('winner');
                    setBalance(getBalance() + (state.betAmount * state.multiplier));
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    targetFace.classList.add('loser');
                    tg.HapticFeedback.notificationOccurred('error');
                }

                // –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–∏–≥—Ä—ã
                if(state.autoActive) {
                    let shouldStop = false;
                    if(state.autoMode === 'limit') {
                        const limitType = document.getElementById('limit-type').value;
                        const limitAmt = parseFloat(document.getElementById('limit-amount').value) || 0;
                        const currentBal = getBalance();
                        
                        if(limitType === 'profit' && currentBal >= state.startBalance + limitAmt) shouldStop = true;
                        if(limitType === 'loss' && currentBal <= state.startBalance - limitAmt) shouldStop = true;
                    }
                    
                    if(shouldStop || getBalance() < state.betAmount) {
                        stopAutoPlay();
                    } else {
                        state.autoTimeout = setTimeout(executeRoll, 1000); // –ü–∞—É–∑–∞ 1 —Å–µ–∫ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –±—Ä–æ—Å–∫–æ–º
                    }
                }
            }, 1500);
        }

        window.onload = setupUser;
    </script>
</body>
                </html>
