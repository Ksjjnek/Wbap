<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Dice Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle, #2c2c2c, #000000); font-family: 'Segoe UI', sans-serif; color: white; }
        
        /* Профиль пользователя (из прошлого шага) */
        #user-header {
            position: absolute; top: 20px; left: 20px;
            display: flex; align-items: center; gap: 12px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
            z-index: 10;
        }
        #user-photo { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #ffffff; object-fit: cover; }
        #user-info { display: flex; flex-direction: column; }
        #user-name { font-weight: bold; font-size: 14px; }
        #user-username { font-size: 12px; opacity: 0.6; }

        /* Интерфейс */
        #ui-container {
            position: absolute; bottom: 40px; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            z-index: 10;
        }
        #result-text { font-size: 32px; font-weight: 800; opacity: 0; transition: 0.5s; text-transform: uppercase; letter-spacing: 2px; }
        
        #roll-button {
            padding: 16px 50px; font-size: 18px; font-weight: bold;
            border-radius: 50px; border: none; background: #ffffff; color: #000;
            cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        #roll-button:active { transform: scale(0.9); }
        #roll-button:disabled { background: #555; cursor: not-allowed; }
    </style>
</head>
<body>

    <div id="user-header">
        <img id="user-photo" src="" alt="" style="display:none;">
        <div id="user-info">
            <div id="user-name">Загрузка...</div>
            <div id="user-username"></div>
        </div>
    </div>

    <div id="ui-container">
        <div id="result-text">Выпало: <span id="dice-value">0</span></div>
        <button id="roll-button">КИНУТЬ КУБИК</button>
    </div>

    <script>
        // --- ДАННЫЕ TELEGRAM ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe?.user;

        if (user) {
            document.getElementById('user-name').innerText = user.first_name;
            document.getElementById('user-username').innerText = user.username ? `@${user.username}` : 'ID: ' + user.id;
            if (user.photo_url) {
                const img = document.getElementById('user-photo');
                img.src = user.photo_url;
                img.style.display = 'block';
            }
        }

        // --- THREE.JS ЛОГИКА ---
        let scene, camera, renderer, cube;
        let isRolling = false;

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 7); // Начальная позиция камеры (далеко)

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 0.8);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            // Создание текстур (Серый фон, Белые цифры)
            const createDiceFace = (num) => {
                const canvas = document.createElement('canvas');
                canvas.width = 256; canvas.height = 256;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#444444'; // Темно-серый цвет грани
                ctx.fillRect(0, 0, 256, 256);
                ctx.strokeStyle = '#666666'; ctx.lineWidth = 10; ctx.strokeRect(0,0,256,256);
                ctx.fillStyle = '#ffffff'; // Белые цифры
                ctx.font = 'bold 120px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(num, 128, 128);
                const texture = new THREE.CanvasTexture(canvas);
                return new THREE.MeshStandardMaterial({ 
                    map: texture, 
                    transparent: true, 
                    opacity: 0.8, // Полупрозрачность
                    roughness: 0.3,
                    metalness: 0.2
                });
            };

            const materials = [
                createDiceFace('1'), createDiceFace('6'),
                createDiceFace('2'), createDiceFace('5'),
                createDiceFace('3'), createDiceFace('4')
            ];

            cube = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), materials);
            scene.add(cube);
            
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (isRolling) {
                cube.rotation.x += 0.25;
                cube.rotation.y += 0.2;
                cube.rotation.z += 0.15;
            }
            renderer.render(scene, camera);
        }

        // Логика броска
        const btn = document.getElementById('roll-button');
        const resText = document.getElementById('result-text');
        const resVal = document.getElementById('dice-value');

        btn.onclick = () => {
            if (isRolling) return;
            isRolling = true;
            btn.disabled = true;
            resText.style.opacity = '0';
            tg.HapticFeedback.impactOccurred('heavy');

            // Анимация "Полета" (Кубик вверх и назад)
            let startTime = Date.now();
            let duration = 1500;

            const throwInterval = setInterval(() => {
                let elapsed = Date.now() - startTime;
                let progress = elapsed / duration;

                if (progress < 0.5) {
                    // Взлет
                    cube.position.y = progress * 6; 
                    camera.position.z = 7 + progress * 4;
                } else if (progress < 1) {
                    // Падение и приближение
                    cube.position.y = (1 - progress) * 6;
                    camera.position.z = 11 - (progress - 0.5) * 16; // Камера "подлетает" близко к 3
                } else {
                    clearInterval(throwInterval);
                    finishRoll();
                }
            }, 16);
        };

        function finishRoll() {
            isRolling = false;
            const result = Math.floor(Math.random() * 6) + 1;
            
            // Фиксируем углы для правильной грани
            const rotations = {
                1: [0, Math.PI/2, 0],
                6: [0, -Math.PI/2, 0],
                2: [-Math.PI/2, 0, 0],
                5: [Math.PI/2, 0, 0],
                3: [0, 0, 0],
                4: [0, Math.PI, 0]
            };

            cube.rotation.set(...rotations[result]);
            cube.position.y = 0;
            camera.position.z = 4; // Финальный зум

            resVal.innerText = result;
            resText.style.opacity = '1';
            btn.disabled = false;
            
            tg.HapticFeedback.notificationOccurred('success');
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init3D();
    </script>
</body>
</html>
