<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Plinko Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    
    <style>
        body {
            margin: 0; padding: 0; background-color: #1c1c1e; color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }

        /* --- –ù–û–í–û–ï: –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è --- */
        .profile-container {
            position: absolute; top: 15px; left: 15px; display: flex; align-items: center;
            background: rgba(44, 44, 46, 0.8); padding: 5px 12px 5px 5px; border-radius: 25px; 
            cursor: pointer; z-index: 100; backdrop-filter: blur(5px);
        }
        .avatar { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; background: #3a3a3c; }
        .balance-text { margin-left: 10px; font-weight: bold; font-size: 14px; }

        /* --- –ù–û–í–û–ï: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.show { display: flex; opacity: 1; }
        .modal-content {
            background: #2c2c2e; padding: 25px; border-radius: 20px; width: 75%; 
            max-width: 300px; text-align: center; position: relative;
        }
        .close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 24px; 
            color: #8e8e93; cursor: pointer;
        }
        .modal-item { margin: 15px 0; font-size: 16px; background: #1c1c1e; padding: 15px; border-radius: 10px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π */
        .toggle-container {
            position: relative; width: 80%; background: #2c2c2e; border-radius: 25px;
            display: flex; margin: 15px 0; padding: 5px; box-sizing: border-box; margin-top: 60px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –ø—Ä–æ—Ñ–∏–ª—å */
        }
        .toggle-btn {
            flex: 1; text-align: center; padding: 10px; z-index: 2; cursor: pointer;
            font-weight: bold; font-size: 14px; transition: color 0.3s;
        }
        .toggle-slider {
            position: absolute; top: 5px; left: 5px; width: calc(50% - 5px); height: calc(100% - 10px);
            background: #0a84ff; border-radius: 20px; transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); z-index: 1;
        }
        .demo-mode .toggle-slider { transform: translateX(0); }
        .balance-mode .toggle-slider { transform: translateX(100%); }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        #game-container { position: relative; width: 100%; max-width: 400px; height: 350px; }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ */
        .multipliers {
            display: flex; justify-content: space-between; width: 100%; max-width: 400px;
            padding: 0 10px; box-sizing: border-box; margin-top: -20px; z-index: 10;
        }
        .multiplier {
            background: #ff9f0a; padding: 5px; border-radius: 5px; font-size: 12px; font-weight: bold;
            opacity: 0; transform: translateY(10px); transition: all 0.5s ease; width: 35px; text-align: center;
        }
        .multiplier.show { opacity: 1; transform: translateY(0); }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { width: 90%; max-width: 400px; margin-top: 10px; text-align: center; }
        .btn-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .btn-row button {
            background: #3a3a3c; border: none; color: white; padding: 10px 15px;
            border-radius: 10px; cursor: pointer; font-size: 14px; transition: 0.2s;
        }
        .btn-row button.active { background: #32d74b; transform: scale(1.05); }
        
        .play-btn {
            width: 100%; background: #32d74b; color: #fff; border: none;
            padding: 15px; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer;
            transition: 0.2s;
        }
        .play-btn:active { transform: scale(0.95); }
        .cost-display { margin-top: 10px; font-size: 14px; color: #8e8e93; }
        .bet-toggle-container { margin-top: 0; margin-bottom: 15px; } /* –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç—Å—Ç—É–ø–∞ –¥–ª—è —Å—Ç–∞–≤–∫–∏ */
    </style>
</head>
<body>

    <div class="profile-container" onclick="toggleModal(true)">
        <img id="user-avatar" src="https://ui-avatars.com/api/?name=User&background=random" alt="Avatar" class="avatar" onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
        <span id="header-balance" class="balance-text">1000 ü™ô</span>
    </div>

    <div id="profile-modal" class="modal" onclick="toggleModal(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="toggleModal(false)">&times;</span>
            <h2>–¢–≤–æ–π –∫–æ—à–µ–ª–µ–∫</h2>
            <div class="modal-item">
                <span style="color: #8e8e93; font-size: 12px; display: block;">–†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</span>
                <strong style="font-size: 20px;"><span id="modal-real-balance">0.00</span> USDT</strong>
            </div>
            <div class="modal-item">
                <span style="color: #8e8e93; font-size: 12px; display: block;">–î–µ–º–æ –±–∞–ª–∞–Ω—Å</span>
                <strong style="font-size: 20px;"><span id="modal-demo-balance">1000</span> ü™ô</strong>
            </div>
        </div>
    </div>

    <div class="toggle-container demo-mode" id="mode-toggle">
        <div class="toggle-slider"></div>
        <div class="toggle-btn" onclick="setMode('demo')">–î–µ–º–æ</div>
        <div class="toggle-btn" onclick="setMode('balance')">–ë–∞–ª–∞–Ω—Å</div>
    </div>

    <div id="game-container"></div>
    
    <div class="multipliers" id="multipliers-container"></div>

    <div class="controls">
        <p style="margin: 0 0 5px 0; font-size: 12px; color: #8e8e93;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–∏–∫–æ–≤:</p>
        <div class="btn-row" id="balls-row">
            <button class="active" onclick="setBalls(1, this)">1</button>
            <button onclick="setBalls(2, this)">2</button>
            <button onclick="setBalls(5, this)">5</button>
            <button onclick="setBalls(10, this)">10</button>
            <button onclick="setBalls(25, this)">25</button>
            <button onclick="setBalls(50, this)">50</button>
        </div>

        <p style="margin: 10px 0 5px 0; font-size: 12px; color: #8e8e93;">–°—Ç–∞–≤–∫–∞:</p>
        <div class="toggle-container demo-mode bet-toggle-container" id="bet-toggle">
            <div class="toggle-slider"></div>
            <div class="toggle-btn" onclick="setBet(10, this)">10</div>
            <div class="toggle-btn" onclick="setBet(100, this)">100</div>
        </div>

        <button class="play-btn" onclick="play()">–ò–ì–†–ê–¢–¨</button>
        <div class="cost-display" id="total-cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 10 ü™ô</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        // –ë–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let demoBalance = 1000;
        let realBalance = 0.00;
        
        let currentMode = 'demo';
        let ballsCount = 1;
        let betAmount = 10;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        const user = tg.initDataUnsafe?.user;
        if (user) {
            if (user.photo_url) {
                document.getElementById('user-avatar').src = user.photo_url;
            } else {
                // –ï—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏ –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–≥–ª—É—à–∫—É —Å –ø–µ—Ä–≤–æ–π –±—É–∫–≤–æ–π –∏–º–µ–Ω–∏
                document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${user.first_name}&background=32d74b&color=fff`;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–∞–ª–∞–Ω—Å–æ–≤
        function updateBalances() {
            // –ï—Å–ª–∏ –¥–µ–º–æ –±–∞–ª–∞–Ω—Å —É–ø–∞–ª –Ω–∏–∂–µ 100, –≤–æ—Å–ø–æ–ª–Ω—è–µ–º –µ–≥–æ
            if (demoBalance < 100) demoBalance = 100;

            document.getElementById('modal-demo-balance').innerText = Math.floor(demoBalance);
            document.getElementById('modal-real-balance').innerText = realBalance.toFixed(2);
            
            const headerBal = currentMode === 'demo' ? `${Math.floor(demoBalance)} ü™ô` : `${realBalance.toFixed(2)} USDT`;
            document.getElementById('header-balance').innerText = headerBal;
        }

        function toggleModal(show) {
            const modal = document.getElementById('profile-modal');
            if (show) modal.classList.add('show');
            else modal.classList.remove('show');
            updateBalances();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI
        function setMode(mode) {
            currentMode = mode;
            const toggle = document.getElementById('mode-toggle');
            if (mode === 'demo') { toggle.classList.replace('balance-mode', 'demo-mode'); } 
            else { toggle.classList.replace('demo-mode', 'balance-mode'); }
            updateBalances();
            updateCost();
        }

        function setBalls(count, btn) {
            ballsCount = count;
            document.querySelectorAll('#balls-row button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateCost();
        }

        function setBet(amount, btn) {
            betAmount = amount;
            const toggle = document.getElementById('bet-toggle');
            if (amount === 10) { toggle.classList.replace('balance-mode', 'demo-mode'); } 
            else { toggle.classList.replace('demo-mode', 'balance-mode'); }
            updateCost();
        }

        function updateCost() {
            const total = ballsCount * betAmount;
            const currency = currentMode === 'demo' ? 'ü™ô' : 'USDT';
            document.getElementById('total-cost').innerText = `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${total} ${currency}`;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π (10x –ø–æ —Ü–µ–Ω—Ç—Ä—É)
        const mults = ['0.5x', '1.5x', '3x', '10x', '3x', '1.5x', '0.5x'];
        const multContainer = document.getElementById('multipliers-container');
        mults.forEach((m, i) => {
            let el = document.createElement('div');
            el.className = 'multiplier';
            el.innerText = m;
            multContainer.appendChild(el);
            setTimeout(() => el.classList.add('show'), 500 + (i * 100));
        });

        // --- –§–∏–∑–∏–∫–∞ Matter.js ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite;

        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: { width: 400, height: 350, wireframes: false, background: 'transparent' }
        });

        const pegs = [];
        const rows = 8;
        for (let i = 2; i < rows; i++) {
            for (let j = 0; j <= i; j++) {
                let x = 200 + (j * 40) - (i * 20);
                let y = 50 + (i * 35);
                pegs.push(Bodies.circle(x, y, 4, { isStatic: true, render: { fillStyle: '#ffffff' } }));
            }
        }
        Composite.add(engine.world, pegs);
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // –§—É–Ω–∫—Ü–∏—è –∏–≥—Ä—ã
        function play() {
            const totalCost = ballsCount * betAmount;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
            if (currentMode === 'demo') {
                if (demoBalance < totalCost) {
                    tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–º–æ-–º–æ–Ω–µ—Ç!");
                    return;
                }
                demoBalance -= totalCost;
                updateBalances();
            } else {
                if (realBalance < totalCost) {
                    tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ USDT –Ω–∞ –±–∞–ª–∞–Ω—Å–µ! –ü–æ–ø–æ–ª–Ω–∏—Ç–µ —Å—á–µ—Ç.");
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å tg.sendData –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —É –±–æ—Ç–∞
                    return;
                }
                realBalance -= totalCost;
                updateBalances();
            }

            // –ó–∞–ø—É—Å–∫ —à–∞—Ä–∏–∫–æ–≤
            for (let i = 0; i < ballsCount; i++) {
                setTimeout(() => {
                    let xOffset = 200 + (Math.random() * 10 - 5);
                    let ball = Bodies.circle(xOffset, 10, 8, { 
                        restitution: 0.8, friction: 0.001,
                        render: { fillStyle: '#ff3b30' } 
                    });
                    Composite.add(engine.world, ball);
                    
                    // –£–¥–∞–ª—è–µ–º —à–∞—Ä–∏–∫ –∏ –∑–∞—á–∏—Å–ª—è–µ–º –≤–æ–æ–±—Ä–∞–∂–∞–µ–º—ã–π –≤—ã–∏–≥—Ä—ã—à
                    setTimeout(() => { 
                        Composite.remove(engine.world, ball); 
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –≤—ã—á–∏—Å–ª—è—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É X —à–∞—Ä–∏–∫–∞
                        // –∏ —É–º–Ω–æ–∂–∞—Ç—å —Å—Ç–∞–≤–∫—É –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —è—á–µ–π–∫–∏
                    }, 4000);
                }, i * 200);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateBalances();
        updateCost();
    </script>
</body>
</html>
