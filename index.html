<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NovaChat</title>
<style>
body { font-family: Arial; background:#0f172a; color:white; margin:0; text-align:center; }
#registration, #chat { display:none; height:100vh; flex-direction:column; }
#start { display:block; margin-top:150px; }
button { padding:15px 30px; font-size:18px; border:none; border-radius:10px; background:#3b82f6; color:white; cursor:pointer; }
#messages { flex:1; overflow:auto; padding:20px; text-align:left; }
#input { display:flex; padding:10px; background:#1e293b; }
#input input { flex:1; padding:10px; border:none; border-radius:8px; }
#input button { margin-left:10px; }
label { font-size:14px; margin-left:10px; }
h2 { margin-top:30px; }
</style>
</head>
<body>

<div id="start">
  <h1>NovaChat üí¨</h1>
  <p>–ù–∞–∂–º–∏—Ç–µ START, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
  <button onclick="openRegistration()">START</button>
</div>

<div id="registration">
  <h2>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞</h2>
  <input id="usercode" placeholder="–ö–æ–¥" style="padding:10px; font-size:16px;">
  <button onclick="verifyCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="input">
    <input id="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

let nickname = null;
let allowedCode = null;
let allowedUserId = null;

// –ü–æ–ª—É—á–∞–µ–º user_id –∏ code –∏–∑ URL
const params = new URLSearchParams(window.location.search);
if(params.has("user") && params.has("code")){
    allowedUserId = params.get("user");
    allowedCode = params.get("code");
} else {
    document.body.innerHTML="<h2 style='color:red; margin-top:50px;'>‚ùå –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞</h2>";
}

// –§—É–Ω–∫—Ü–∏–∏
function openRegistration(){
    document.getElementById("start").style.display="none";
    document.getElementById("registration").style.display="block";
}

function verifyCode(){
    const inputCode = document.getElementById("usercode").value.trim();
    if(inputCode === allowedCode){
        nickname = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫ –¥–ª—è —á–∞—Ç–∞:");
        if(!nickname) {
            alert("–ù–∏–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
            return;
        }
        const showAnnouncement = confirm("–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –æ –≤–∞—à–µ–º –≤—Ö–æ–¥–µ –≤ —á–∞—Ç –±—ã–ª–æ –æ–±—ä—è–≤–ª–µ–Ω–æ?");
        document.getElementById("registration").style.display="none";
        document.getElementById("chat").style.display="flex";
        if(showAnnouncement){
            addMessage("–°–∏—Å—Ç–µ–º–∞", `${nickname} –≤–æ—à—ë–ª –≤ —á–∞—Ç!`);
            tg.sendData(`SYSTEM_ANNOUNCE: ${nickname} –≤–æ—à—ë–ª –≤ —á–∞—Ç!`);
        }
    } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞");
    }
}

function send(){
    const textInput = document.getElementById("text");
    let text = textInput.value.trim();
    if(!text || !nickname) return;
    addMessage(nickname, text);
    textInput.value="";
    tg.sendData(text); // –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É
}

function addMessage(name,text){
    const msg = document.createElement("div");
    msg.innerHTML = `<b>${name}:</b> ${text}`;
    document.getElementById("messages").appendChild(msg);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}
</script>
</body>
</html>
