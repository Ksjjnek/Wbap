<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Dice 3D</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; color: white; }
        
        /* Профиль пользователя */
        #user-header {
            position: absolute; top: 10px; left: 10px;
            display: flex; align-items: center; gap: 10px;
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 25px;
            z-index: 10;
        }
        #user-photo { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #0088cc; }
        
        /* Результат */
        #result-display {
            position: absolute; top: 20%; width: 100%; text-align: center;
            font-size: 48px; font-weight: bold; text-shadow: 0 0 15px #0088cc;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }

        /* Кнопка */
        #roll-button {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            padding: 15px 40px; font-size: 20px; border-radius: 30px;
            border: none; background: #0088cc; color: white; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10;
        }
        #roll-button:active { transform: translateX(-50%) scale(0.95); }
    </style>
</head>
<body>

    <div id="user-header">
        <img id="user-photo" src="" alt="" style="display:none;">
        <div>
            <div id="user-name">Загрузка...</div>
            <div id="user-username" style="font-size: 10px; opacity: 0.7;"></div>
        </div>
    </div>

    <div id="result-display">Выпало: <span id="dice-value">0</span></div>
    <button id="roll-button">БРОСИТЬ КУБИК</button>

    <script>
        // --- ЧАСТЬ 1: ДАННЫЕ TELEGRAM ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe?.user;

        if (user) {
            document.getElementById('user-name').innerText = user.first_name;
            document.getElementById('user-username').innerText = user.username ? `@${user.username}` : '';
            if (user.photo_url) {
                const img = document.getElementById('user-photo');
                img.src = user.photo_url;
                img.style.display = 'block';
            }
        }

        // --- ЧАСТЬ 2: 3D КУБИК (THREE.JS) ---
        let scene, camera, renderer, cube;
        let isRolling = false;

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(2, 5, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            // Создаем текстуры граней с цифрами
            const loader = new THREE.TextureLoader();
            const createTextCanvas = (text) => {
                const canvas = document.createElement('canvas');
                canvas.width = 256; canvas.height = 256;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, 256, 256);
                ctx.fillStyle = '#0088cc'; ctx.font = 'bold 160px Arial';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(text, 128, 128);
                return new THREE.CanvasTexture(canvas);
            };

            const materials = [
                new THREE.MeshStandardMaterial({ map: createTextCanvas('1') }),
                new THREE.MeshStandardMaterial({ map: createTextCanvas('6') }),
                new THREE.MeshStandardMaterial({ map: createTextCanvas('2') }),
                new THREE.MeshStandardMaterial({ map: createTextCanvas('5') }),
                new THREE.MeshStandardMaterial({ map: createTextCanvas('3') }),
                new THREE.MeshStandardMaterial({ map: createTextCanvas('4') }),
            ];

            const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
            cube = new THREE.Mesh(geometry, materials);
            scene.add(cube);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (isRolling) {
                cube.rotation.x += 0.2;
                cube.rotation.y += 0.15;
            }
            renderer.render(scene, camera);
        }

        // --- ЧАСТЬ 3: ЛОГИКА БРОСКА ---
        const btn = document.getElementById('roll-button');
        const resDiv = document.getElementById('result-display');
        const resVal = document.getElementById('dice-value');

        btn.onclick = () => {
            if (isRolling) return;
            
            isRolling = true;
            resDiv.style.opacity = '0';
            tg.HapticFeedback.impactOccurred('medium'); // Виброотклик в Telegram

            setTimeout(() => {
                isRolling = false;
                const result = Math.floor(Math.random() * 6) + 1;
                
                // Устанавливаем кубик в положение, соответствующее результату
                const rotations = {
                    1: {x: 0, y: Math.PI/2},
                    6: {x: 0, y: -Math.PI/2},
                    2: {x: -Math.PI/2, y: 0},
                    5: {x: Math.PI/2, y: 0},
                    3: {x: 0, y: 0},
                    4: {x: 0, y: Math.PI}
                };

                cube.rotation.x = rotations[result].x;
                cube.rotation.y = rotations[result].y;
                
                resVal.innerText = result;
                resDiv.style.opacity = '1';
                
                // Сообщаем Telegram об успехе
                tg.HapticFeedback.notificationOccurred('success');
            }, 1500);
        };

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

        init3D();
    </script>
</body>
</html>
